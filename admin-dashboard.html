<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f0f2f5;
      font-family: Arial, sans-serif;
    }
    .navbar {
      background-color: #003385;
    }
    .navbar .nav-link {
      color: #ffffff;
    }
    .navbar .nav-link:hover {
      color: #000000;
      text-shadow:
        -1px -1px 0 #ffffff,
         1px -1px 0 #ffffff,
        -1px  1px 0 #ffffff,
         1px  1px 0 #ffffff;
    }
    .navbar-brand img {
      height: 40px;
    }
    .navbar-nav {
      flex-direction: row;
      flex-wrap: nowrap;
    }
    .navbar-nav .nav-item {
      white-space: nowrap;
    }
    .navbar-nav .nav-link {
      padding-left: 0.8rem;
      padding-right: 0.8rem;
    }
    .card {
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      margin-top: 40px;
    }
    .badge-admin {
      background-color: #003385;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark px-3">
    <a class="navbar-brand d-flex align-items-center" href="index.html">
      <img src="images/DC.jpg" alt="Logo" width="105" height="100">
    </a>
    <ul class="navbar-nav ms-auto d-flex flex-row mb-0">
      <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
      <li class="nav-item"><a class="nav-link" href="admin-login.html">Admin Login</a></li>
      <li class="nav-item"><a class="nav-link active" href="admin-dashboard.html">Dashboard</a></li>
    </ul>
  </nav>

  <div class="container">
    <div class="card p-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h2 class="mb-0">Registered Users</h2>
          <small id="adminWelcome" class="text-muted"></small>
        </div>
        <div class="d-flex gap-2">
          <button id="refreshBtn" class="btn btn-outline-primary">Refresh</button>
          <button id="logoutBtn" class="btn btn-outline-danger">Logout</button>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th scope="col">ID</th>
              <th scope="col">Username</th>
              <th scope="col">Email</th>
              <th scope="col">Role</th>
              <th scope="col">Created</th>
            </tr>
          </thead>
          <tbody id="userTableBody">
            <tr>
              <td colspan="5" class="text-center text-muted">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_BASE = 'http://localhost:8081';

    function requireAdminSession() {
      const token = localStorage.getItem('adminToken');
      if (!token) {
        window.location.href = 'admin-login.html';
        return null;
      }
      return token;
    }

    async function loadUsers(token) {
      const tbody = document.getElementById('userTableBody');
      tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Loading...</td></tr>';
      try {
        const res = await fetch(`${API_BASE}/api/admin/users`, {
          headers: { 'X-Admin-Token': token }
        });
        if (!res.ok) {
          if (res.status === 401) {
            alert('Session expired. Please log in again.');
            localStorage.removeItem('adminToken');
            window.location.href = 'admin-login.html';
            return;
          }
          throw new Error(`Failed with status ${res.status}`);
        }
        const users = await res.json();
        if (!Array.isArray(users) || users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No users found.</td></tr>';
          return;
        }
        tbody.innerHTML = users.map(user => {
          const role = user.admin ? '<span class="badge badge-admin text-bg-primary">Admin</span>' : 'User';
          const created = user.createdAt ? new Date(user.createdAt).toLocaleString() : '';
          return `
            <tr>
              <td>${user.id}</td>
              <td>${user.username}</td>
              <td>${user.email}</td>
              <td>${role}</td>
              <td>${created}</td>
            </tr>`;
        }).join('');
      } catch (err) {
        console.error('Could not load users', err);
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Failed to load users.</td></tr>';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const token = requireAdminSession();
      if (!token) return;

      const adminName = localStorage.getItem('adminUsername');
      if (adminName) {
        const welcome = document.getElementById('adminWelcome');
        welcome.textContent = `Logged in as ${adminName}`;
      }

      const refreshBtn = document.getElementById('refreshBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      refreshBtn.addEventListener('click', () => loadUsers(token));
      logoutBtn.addEventListener('click', async () => {
        try {
          await fetch(`${API_BASE}/api/admin/logout`, {
            method: 'POST',
            headers: { 'X-Admin-Token': token }
          });
        } catch (_) {
          /* ignore */
        }
        localStorage.removeItem('adminToken');
        localStorage.removeItem('adminUsername');
        window.location.href = 'admin-login.html';
      });

      loadUsers(token);
    });
  </script>
</body>
</html>
