<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Profile</title>
<script type="text/javascript" nonce="faee4e0824df4e9aa4a86bc6a38" src="//local.adguard.org?ts=1763705977418&amp;type=content-script&amp;dmn=apps.abacus.ai&amp;url=https%3A%2F%2Fapps.abacus.ai%2Fapi%2FdownloadAgentAttachment%3FdeploymentId%3D13914165be%26attachmentId%3D4452c353-9574-4106-a4b1-025ff7881648&amp;app=msedge.exe&amp;css=3&amp;js=1&amp;rel=1&amp;rji=1&amp;sbe=1"></script><script type="text/javascript" nonce="faee4e0824df4e9aa4a86bc6a38" src="//local.adguard.org?ts=1763705977418&amp;name=AdGuard%20Extra&amp;name=AdGuard%20Popup%20Blocker&amp;type=user-script"></script><script type="text/javascript" nonce="faee4e0824df4e9aa4a86bc6a38" src="//local.adguard.org?ts=1763705977418&amp;type=content-script&amp;dmn=apps.abacus.ai&amp;url=https%3A%2F%2Fapps.abacus.ai%2Fapi%2FdownloadAgentAttachment%3FdeploymentId%3D13914165be%26attachmentId%3D03988d9c-e376-4ed0-b5c6-5c9d7442e3e7&amp;app=msedge.exe&amp;css=3&amp;js=1&amp;rel=1&amp;rji=1&amp;sbe=1"></script><script type="text/javascript" nonce="faee4e0824df4e9aa4a86bc6a38" src="//local.adguard.org?ts=1763705977418&amp;name=AdGuard%20Extra&amp;name=AdGuard%20Popup%20Blocker&amp;type=user-script"></script><script type="text/javascript" nonce="cb00747402c2440d801bc051d74" src="//local.adguard.org?ts=1763666942399&amp;type=content-script&amp;dmn=apps.abacus.ai&amp;url=https%3A%2F%2Fapps.abacus.ai%2Fapi%2FdownloadAgentAttachment%3FdeploymentId%3D13914165be%26attachmentId%3D3ca013e2-c770-47c7-9cef-2d83b6160efc&amp;app=msedge.exe&amp;css=3&amp;js=1&amp;rel=1&amp;rji=1&amp;sbe=1"></script><script type="text/javascript" nonce="cb00747402c2440d801bc051d74" src="//local.adguard.org?ts=1763666942399&amp;name=AdGuard%20Extra&amp;name=AdGuard%20Popup%20Blocker&amp;type=user-script"></script><script type="text/javascript" nonce="ffb57a5d58fa46e883b61de7142" src="//local.adguard.org?ts=1762799034039&amp;type=content-script&amp;dmn=apps.abacus.ai&amp;url=https%3A%2F%2Fapps.abacus.ai%2Fapi%2FdownloadAgentAttachment%3FdeploymentId%3D13914165be%26attachmentId%3Da71125d8-2f13-4781-9ad0-d743a073df98&amp;app=msedge.exe&amp;css=3&amp;js=1&amp;rel=1&amp;rji=1&amp;sbe=0"></script><script type="text/javascript" nonce="ffb57a5d58fa46e883b61de7142" src="//local.adguard.org?ts=1762799034039&amp;name=AdGuard%20Extra&amp;name=AdGuard%20Popup%20Blocker&amp;type=user-script"></script><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="css/dark-mode.css">
<style>
    body {
      background-color: #f0f2f5;
      font-family: Arial, sans-serif;
    }
 
    /*Navbar*/
    .navbar {
      background-color: #003385;
    }
    .navbar .nav-link {
      color: #ffffff; 
    }
    .navbar .nav-link:hover {
    color: #000000;
    text-shadow:
      -1px -1px 0 #ffffff,
       1px -1px 0 #ffffff,
      -1px  1px 0 #ffffff,
       1px  1px 0 #ffffff;
      }
    .navbar-brand img {
      height: 40px;
    }
    .navbar-nav {
      flex-direction: row;
      flex-wrap: nowrap;
    }
 
    .navbar-nav .nav-item {
      white-space: nowrap;
    }
    .navbar-nav .nav-link {
      padding-left: 0.8rem;
      padding-right: 0.8rem;
    }

    /* Search Bar Styles */
    .search-container {
      position: relative;
      margin-left: 1rem;
      margin-right: 1rem;
    }
    .search-input {
      width: 250px;
      padding: 0.375rem 0.75rem;
      border-radius: 20px;
      border: 1px solid #ddd;
      background-color: #f0f2f5;
    }
    .search-input:focus {
      outline: none;
      border-color: #003385;
      background-color: white;
    }
    .search-button {
      background-color: #003385;
      color: white;
      border: none;
      padding: 0.375rem 1rem;
      border-radius: 20px;
      margin-left: 0.5rem;
      cursor: pointer;
    }
    .search-button:hover {
      background-color: #002266;
    }
    .search-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      width: 250px;
      background-color: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-top: 5px;
      max-height: 300px;
      overflow-y: auto;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      z-index: 1000;
      display: none;
    }
    .search-dropdown.show {
      display: block;
    }
    .search-result-item {
      padding: 10px 15px;
      cursor: pointer;
      border-bottom: 1px solid #f0f2f5;
      display: flex;
      align-items: center;
    }
    .search-result-item:hover {
      background-color: #f0f2f5;
    }
    .search-result-item img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      margin-right: 10px;
      object-fit: cover;
    }
    .search-result-item .username {
      font-weight: 500;
      color: #003385;
    }
    .search-no-results {
      padding: 15px;
      text-align: center;
      color: #666;
    }
 
    /* Profile Section */
    .profile-card {
      max-width: 750px;
      margin: 40px auto;
      background-color: #fff;
      border-radius: 25px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      padding: 20px 30px;
    }
 
    .profile-header {
      display: flex;
      align-items: center;
      gap: 20px;
    }
 
    .profile-pic-container {
      position: relative;
      width: 120px;
      height: 120px;
    }

    .profile-header img {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid #003385;
      cursor: pointer;
    }

    .profile-pic-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .profile-pic-container:hover .profile-pic-overlay {
      display: flex;
    }

    #profilePicInput {
      display: none;
    }
 
    #displayName {
      font-size: 1.5rem;
      font-weight: bold;
      margin: 0;
    }

    #displayFollowers {
      font-size: 1rem;
      margin-left: 0.2rem;
    }

    #displayFollowing {
      font-size: 1rem;
      margin-left: 2rem;
    }

    .same {
      display:inline-block;
    }
 
    /* Major / Minor / Year Row */
    .details-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 10px;
    }
 
    .details-row p {
      margin: 0;
      font-size: 0.95rem;
      color: #555;
    }
 
    .details-row input,
    .details-row select {
      display: none;
      padding: 6px 8px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 0.9rem;
    }
 
    /* Bio */
    .bio-section {
      margin-top: 15px;
    }
    .bio-section p {
      color: #444;
      margin: 0;
    }
    #bioInput {
      display: none;
      width: 100%;
      margin-top: 5px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      resize: vertical;
    }
 
    /* Post box (separate card) */
    .post-card {
      max-width: 750px;
      margin: 20px auto;
      background-color: #fff;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
      padding: 20px;
    }
 
    #postContent {
      resize: vertical;
    }
 
    /* Edit/Save buttons */
    #editBtn {
    position: absolute;
    top: 10px;
    right: 100px;
    padding: 5px 15px;  
    font-size: 1.1rem;
    }
    
    #saveBtn {
      position: absolute;
      top: 10px;
      right: 20px;
      display: none;
      padding: 5px 15px;  
      font-size: 1.1rem;
    }

    /* User Posts Section */
    .user-post-card {
      max-width: 750px;
      margin: 20px auto;
      background-color: #fff;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
      padding: 20px;
    }
    .post-image {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 10px;
    }
    .post-timestamp {
      font-size: 0.85rem;
      color: #65676b;
    }
    .post-actions button {
      margin-right: 10px;
    }
    /* Comments Section */
    .comment-section {
      margin-top: 10px;
      border-top: 1px solid #ddd;
      padding-top: 10px;
    }
    .comment {
      background-color: #ffffff;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 10px;
    }
    .comment-text {
      font-size: 0.95rem;
    }
    .comment-actions button {
      margin-right: 5px;
      border-radius: 20px;
      font-size: 0.8rem;
    }
    .comment-actions button:hover {
      opacity: 0.9;
    }
</style>
</head>
<body>
  <script>
    // Scroll to specific post if postId is in URL
    window.addEventListener('load', function() {
      const urlParams = new URLSearchParams(window.location.search);
      const targetPostId = urlParams.get('postId');

      if (targetPostId) {
        // Wait for posts to load, then scroll
        setTimeout(() => {
          const targetPost = document.querySelector(`[data-post-id="${targetPostId}"]`);
          if (targetPost) {
            targetPost.scrollIntoView({ behavior: 'smooth', block: 'center' });
            // Highlight the post briefly
            targetPost.style.border = '3px solid #007bff';
            targetPost.style.transition = 'border 0.3s ease';
            setTimeout(() => {
              targetPost.style.border = '';
            }, 3000);
          } else {
            // If post not found, try again after a longer delay
            setTimeout(() => {
              const retryPost = document.querySelector(`[data-post-id="${targetPostId}"]`);
              if (retryPost) {
                retryPost.scrollIntoView({ behavior: 'smooth', block: 'center' });
                retryPost.style.border = '3px solid #007bff';
                retryPost.style.transition = 'border 0.3s ease';
                setTimeout(() => {
                  retryPost.style.border = '';
                }, 3000);
              }
            }, 2000);
          }
        }, 1000);
      }
    });
    // ==== LIKE/DISLIKE FUNCTIONS ====

    // Toggle Like
    window.toggleLike = async function(postId) {
    if (!currentUser) {
    alert('Please login to like posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/like?userId=${currentUser.id}`, {
    method: 'POST'
    });

    if (!response.ok) throw new Error('Failed to toggle like');

    const data = await response.json();
    updatePostStats(postId, data);
    } catch (error) {
    console.error('Error toggling like:', error);
    }
    };

    // Toggle Dislike
    window.toggleDislike = async function(postId) {
    if (!currentUser) {
    alert('Please login to dislike posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/dislike?userId=${currentUser.id}`, {
    method: 'POST'
    });

    if (!response.ok) throw new Error('Failed to toggle dislike');

    const data = await response.json();
    updatePostStats(postId, data);
    } catch (error) {
    console.error('Error toggling dislike:', error);
    }
    };

    // Update post statistics in UI
    function updatePostStats(postId, data) {
    const postCard = document.querySelector(`[data-post-id="${postId}"]`);
    if (!postCard) return;

    // Update like button and count
    const likeBtn = postCard.querySelector('.like-btn');
    const likeCount = postCard.querySelector('.like-count');
    if (likeBtn && likeCount) {
    likeCount.textContent = data.likeCount;
    if (data.userLiked) {
    likeBtn.classList.remove('btn-outline-success');
    likeBtn.classList.add('btn-success');
    } else {
    likeBtn.classList.remove('btn-success');
    likeBtn.classList.add('btn-outline-success');
    }
    }

    // Update dislike button and count
    const dislikeBtn = postCard.querySelector('.dislike-btn');
    const dislikeCount = postCard.querySelector('.dislike-count');
    if (dislikeBtn && dislikeCount) {
    dislikeCount.textContent = data.dislikeCount;
    if (data.userDisliked) {
    dislikeBtn.classList.remove('btn-outline-danger');
    dislikeBtn.classList.add('btn-danger');
    } else {
    dislikeBtn.classList.remove('btn-danger');
    dislikeBtn.classList.add('btn-outline-danger');
    }
    }
    }

    // ==== COMMENT FUNCTIONS ====

    // Toggle comments visibility
    window.toggleComments = async function(postId) {
    const commentsSection = document.getElementById(`comments-${postId}`);
    if (!commentsSection) return;

    if (commentsSection.style.display === 'none') {
    commentsSection.style.display = 'block';
    await loadComments(postId);
    } else {
    commentsSection.style.display = 'none';
    }
    };

    // Load comments for a post
    async function loadComments(postId) {
    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/comments`);
    if (!response.ok) throw new Error('Failed to load comments');

    const comments = await response.json();
    const commentList = document.getElementById(`comment-list-${postId}`);

    if (comments.length === 0) {
    commentList.innerHTML = '<p class="text-muted">No comments yet</p>';
    return;
    }

    commentList.innerHTML = comments.map(comment => {
    const commentDate = new Date(comment.createdAt);
    const timeAgo = getTimeAgo(commentDate);
    const profilePic = comment.userProfilePicture || 'images/default profile picture.jpg';
    const isOwnComment = currentUser && currentUser.id === comment.userId;
    const isAdmin = currentUser && currentUser.role === 'ADMIN';
    const canDeleteComment = isOwnComment || isAdmin;

    return `
    <div class="comment mb-3" data-comment-id="${comment.id}">
    <div class="d-flex align-items-start">
    <img src="${profilePic}" alt="User" width="40" height="40" 
    class="rounded-circle me-2" onerror="this.src='images/default profile picture.jpg'">
    <div class="flex-grow-1">
    <div>
    <strong>${comment.username}</strong>
    <span class="text-muted ms-2" style="font-size: 0.85rem;">${timeAgo}</span>
    </div>
    <p class="mb-1">${comment.commentText}</p>
    ${canDeleteComment ? `
    <button class="btn btn-sm btn-outline-danger" onclick="deleteComment(${comment.id}, ${postId})">
    Delete${isAdmin && !isOwnComment ? ' (Admin)' : ''}
    </button>
    ` : ''}
    </div>
    </div>
    </div>
    `;
    }).join('');
    } catch (error) {
    console.error('Error loading comments:', error);
    }
    }

    // Add a new comment
    window.addComment = async function(postId) {
    if (!currentUser) {
    alert('Please login to comment');
    return;
    }

    const input = document.getElementById(`comment-input-${postId}`);
    const commentText = input.value.trim();

    if (!commentText) {
    alert('Comment cannot be empty');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/comments?userId=${currentUser.id}`, {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json'
    },
    body: JSON.stringify({ commentText })
    });

    if (!response.ok) throw new Error('Failed to add comment');

    input.value = '';
    await loadComments(postId);

    // Update comment count
    const commentCount = document.querySelector(`[data-post-id="${postId}"] .comment-count`);
    if (commentCount) {
    commentCount.textContent = parseInt(commentCount.textContent) + 1;
    }
    } catch (error) {
    console.error('Error adding comment:', error);
    }
    };

    // Delete a comment
    window.deleteComment = async function(commentId, postId) {
    if (!currentUser) return;

    if (!confirm('Are you sure you want to delete this comment?')) return;

    try {
    const response = await fetch(`${API_BASE}/api/posts/comments/${commentId}?userId=${currentUser.id}`, {
    method: 'DELETE'
    });

    if (!response.ok) throw new Error('Failed to delete comment');

    await loadComments(postId);

    // Update comment count
    const commentCount = document.querySelector(`[data-post-id="${postId}"] .comment-count`);
    if (commentCount) {
    commentCount.textContent = Math.max(0, parseInt(commentCount.textContent) - 1);
    }
    } catch (error) {
    console.error('Error deleting comment:', error);
    }
    };

    // ==== FLAG POST FUNCTION ====

    window.flagPost = async function(postId, reason) {
    if (!currentUser) {
    alert('Please login to flag posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/flags?postId=${postId}&userId=${currentUser.id}&reason=${encodeURIComponent(reason)}`, {
    method: 'POST',
    credentials: 'include'
    });

    const data = await response.json();

    if (!response.ok) {
    throw new Error(data.message || 'Failed to flag post');
    }

    alert(`Post flagged as ${reason} successfully!`);
    loadUserPosts();

      

    } catch (error) {
    console.error('Error:', error);
    alert('Error: ' + error.message);
    }
    };

    // ==== EDIT POST FUNCTION ====

    window.editPost = function(postId, content) {
    console.log('Edit post:', postId, content);
    alert('Edit functionality coming soon!');
    };


    (function() {
      if (localStorage.getItem('theme') === 'dark') {
        document.body.classList.add('dark-mode');
      }
    })();
  </script>
 
   <!-- Navbar -->
<nav class="navbar navbar-dark px-3">
<a class="navbar-brand d-flex align-items-center" href="index.html">
<img src="images/DC.jpg" alt="Logo" width="105" height="100">
</a>

<!-- Search Container -->
<div class="search-container">
  <input type="text" id="searchInput" class="search-input" placeholder="Search users...">
  <button class="search-button" onclick="performSearch()">Search</button>
  <div id="searchDropdown" class="search-dropdown"></div>
</div>

<ul class="navbar-nav ms-auto d-flex flex-row mb-0 align-items-center">
<li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
<li class="nav-item"><a class="nav-link active" href="messages.html">Messages</a></li>
<li class="nav-item"><a class="nav-link" href="notifications.html">Notifications</a></li>
<li class="nav-item"><a class="nav-link" href="settings.html">Settings</a></li>
<li class="nav-item"><a class="nav-link" href="login.html" id="loginLink">Login</a></li>
<li class="nav-item"><a class="nav-link" href="register.html" id="registerLink">Register</a></li>
<li class="nav-item d-none" id="logoutItem">
<a class="nav-link text-danger fw-bold" href="#" id="logoutLink">Logout</a>
</li>
</ul>
</nav>
 
  <!-- Profile Card -->
<div class="profile-card position-relative">
<button id="editBtn" class="btn btn-sm btn-primary">Edit</button>
<button id="saveBtn" class="btn btn-sm btn-success">Save</button>
 
    <div class="profile-header">
      <div class="profile-pic-container">
        <img id="profilePreview" src="images/default profile picture.jpg" alt="Profile Picture">
        <div class="profile-pic-overlay" id="profilePicOverlay">
          Change Photo
        </div>
        <input type="file" id="profilePicInput" accept="image/*">
      </div>
      <div>
        <h2 id="displayName">Your Name</h2>
        <p id="displayFollowers" class="same">Followers: 0</p>
        <p id="displayFollowing" class="same">Following: 0</p>

      </div>
    </div>
 
    <div class="details-row">
<p id="displayMajor">Major: -</p>
<input type="text" id="majorInput" placeholder="Major">
 
      <p id="displayMinor">Minor: -</p>
<input type="text" id="minorInput" placeholder="Minor">
 
      <p id="displayYear">Graduation: -</p>
<select id="graduationYearSelect"></select>
</div>
 
    <div class="bio-section">
<p id="displayBio">Your bio goes here. Share a little about yourself!</p>
<textarea id="bioInput" rows="3"></textarea>
</div>
</div>
 
  <!-- Post Box -->
<div class="post-card">
<h5>Create a Post</h5>
<textarea id="postContent" class="form-control mb-2" rows="3" placeholder="What's on your mind?"></textarea>
<div class="mb-2">
  <label for="postImage" class="form-label text-muted small">üì∑ Add an image (optional)</label>
  <input type="file" class="form-control form-control-sm" id="postImage" accept="image/*">
</div>
<button id="postBtn" class="btn btn-primary w-100">Post</button>
</div>

<!-- User Posts -->
<div class="post-card">
<h5 class="text-center mb-3">My Posts</h5>

<div id="userPosts">

  <!-- Example Static Post -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="d-flex align-items-center mb-2">
        <img src="images/default profile picture.jpg" alt="User" width="45" height="45" class="rounded-circle me-2">
        <div>
          <strong>Your Name</strong><br>
          <span class="post-timestamp">Posted 2 hours ago</span>
        </div>
      </div>
      <p>Excited to share that I just finished my web development project!</p>
      <div class="post-actions mt-3">
                <button class="btn btn-sm btn-outline-success like-btn" data-post-id="">
                  üëç Like (<span class="like-count">0</span>)
                </button>
                <button class="btn btn-sm btn-outline-danger dislike-btn" data-post-id="">
                  üëé Dislike (<span class="dislike-count">0</span>)
                </button>
                <button class="btn btn-sm btn-outline-secondary toggle-comments-btn" data-post-id="">
                  üí¨ Comment (<span class="comment-count">0</span>)
                </button>
                <button class="btn btn-sm btn-outline-primary edit-post-btn" data-post-id="">
                  ‚úèÔ∏è Edit
                </button>
                <button class="btn btn-sm btn-outline-dark delete-post-btn" data-post-id="">
                  üóëÔ∏è Delete
                </button>
      
            <!-- Comment Section -->
<div class="comment-section">
    <!-- Comment Input Row -->
    <div class="d-flex align-items-center mb-3">
      <input type="text" class="form-control form-control-sm me-2" placeholder="Write a comment..." id="commentInput">
      <button class="btn btn-sm btn-primary" id="addCommentBtn">Comment</button>
    </div>
  
    <!-- Example Comment -->
    <div class="comment">
      <div class="d-flex align-items-center mb-2">
        <img src="images/default profile picture.jpg" alt="User" width="45" height="45" class="rounded-circle me-2">
        <div>
          <strong>Your Name</strong><br>
          <span class="post-timestamp">Posted 1 hours ago</span><br>
          <span class="comment-text">This is an example comment!</span>
        </div>
      </div>
      <div class="mt-2 comment-actions d-flex justify-content-start">
        <button class="btn btn-sm btn-outline-success me-2" id="likeCommentBtn">üëç Like</button>
        <button class="btn btn-sm btn-outline-danger me-2" id="dislikeCommentBtn">üëé Dislike</button>
        <button class="btn btn-sm btn-outline-secondary me-2" id="editCommentBtn">‚úèÔ∏è Edit</button>
        <button class="btn btn-sm btn-outline-dark" id="deleteCommentBtn">üóëÔ∏è Delete</button>
      </div>
    </div>
  </div>

</div>
</div>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API_BASE = "http://localhost:8081";
    console.log("[profile] script loaded");
 
    let currentUser = null;

    document.addEventListener('DOMContentLoaded', () => {
      console.log("[profile] DOM ready");
 
      const editBtn = document.getElementById('editBtn');
      const saveBtn = document.getElementById('saveBtn');
      const postBtn = document.getElementById('postBtn');
      const postContent = document.getElementById('postContent');
      const postImage = document.getElementById('postImage');

      const displayName = document.getElementById('displayName');
      const displayBio = document.getElementById('displayBio');
      const displayMajor = document.getElementById('displayMajor');
      const displayMinor = document.getElementById('displayMinor');
      const displayYear = document.getElementById('displayYear');
      
      const bioInput = document.getElementById('bioInput');
      const majorInput = document.getElementById('majorInput');
      const minorInput = document.getElementById('minorInput');
      const graduationYearSelect = document.getElementById('graduationYearSelect');
      
      const profilePreview = document.getElementById('profilePreview');
      const profilePicInput = document.getElementById('profilePicInput');
      const profilePicOverlay = document.getElementById('profilePicOverlay');
      
      const logoutLink = document.getElementById('logoutLink');
      const logoutItem = document.getElementById('logoutItem');
      const loginLink = document.getElementById('loginLink');
      const registerLink = document.getElementById('registerLink');
 
      // REMOVED LOGIN GUARD FOR DEVELOPMENT
      const userStr = localStorage.getItem('currentUser');
      if (userStr) {
        currentUser = JSON.parse(userStr);
        console.log("[profile] Current user:", currentUser);
        
        // Show logout, hide login/register
        logoutItem.classList.remove('d-none');
        loginLink.style.display = 'none';
        registerLink.style.display = 'none';
      } else {
        console.warn("[profile] No user logged in - showing default profile for development");
        // Keep login/register visible, hide logout
        logoutItem.classList.add('d-none');
        loginLink.style.display = 'block';
        registerLink.style.display = 'block';
      }

      // Populate graduation year dropdown
      const currentYear = new Date().getFullYear();
      for (let year = currentYear; year <= currentYear + 10; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        graduationYearSelect.appendChild(option);
      }
 
      // Load profile from backend (only if logged in)
      if (currentUser) {
        (async function loadProfile() {
          try {
            const res = await fetch(`${API_BASE}/api/users/${currentUser.username}`);
            if (res.ok) {
              const user = await res.json();
              currentUser = user; // Update with full data
              localStorage.setItem('currentUser', JSON.stringify(user));
              
              displayName.textContent = user.username || 'Your Name';
              displayBio.textContent = user.bio || 'Your bio goes here. Share a little about yourself!';
              displayMajor.textContent = user.major ? `Major: ${user.major}` : 'Major: -';
              displayMinor.textContent = user.minor ? `Minor: ${user.minor}` : 'Minor: -';
              displayYear.textContent = user.graduationYear ? `Graduation: ${user.graduationYear}` : 'Graduation: -';
              
              if (user.profilePictureUrl) {
                profilePreview.src = user.profilePictureUrl;
              }
              

              // Load follower and following counts
              async function loadFollowerCounts() {
                try {
                  const followerRes = await fetch(`${API_BASE}/api/users/${user.id}/followers/count`);
                  const followingRes = await fetch(`${API_BASE}/api/users/${user.id}/following/count`);

                  if (followerRes.ok && followingRes.ok) {
                    const followerData = await followerRes.json();
                    const followingData = await followingRes.json();

                    document.getElementById('displayFollowers').textContent = `Followers: ${followerData.count}`;
                    document.getElementById('displayFollowing').textContent = `Following: ${followingData.count}`;

                    console.log("[profile] loaded follower counts:", followerData.count, followingData.count);
                  }
                } catch (e) {
                  console.warn("[profile] Failed to load follower counts", e);
                }
              }

              loadFollowerCounts();

              console.log("[profile] loaded profile for", user.username);
            } else {
              console.warn("[profile] GET /api/users/ failed", res.status);
            }
          } catch (e) {
            console.warn("[profile] GET /api/users/ network error", e);
          }
        })();
      }

      // Profile Picture Upload
      profilePicOverlay.addEventListener('click', () => {
        if (!currentUser) {
          alert('Please login to change profile picture');
          return;
        }
        profilePicInput.click();
      });
    // ==== LIKE/DISLIKE FUNCTIONS ====

    // Toggle Like
    window.toggleLike = async function(postId) {
    if (!currentUser) {
    alert('Please login to like posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/like?userId=${currentUser.id}`, {
    method: 'POST'
    });

    if (!response.ok) throw new Error('Failed to toggle like');

    const data = await response.json();
    updatePostStats(postId, data);
    } catch (error) {
    console.error('Error toggling like:', error);
    }
    };

    // Toggle Dislike
    window.toggleDislike = async function(postId) {
    if (!currentUser) {
    alert('Please login to dislike posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/dislike?userId=${currentUser.id}`, {
    method: 'POST'
    });

    if (!response.ok) throw new Error('Failed to toggle dislike');

    const data = await response.json();
    updatePostStats(postId, data);
    } catch (error) {
    console.error('Error toggling dislike:', error);
    }
    };

    // Update post statistics in UI
    function updatePostStats(postId, data) {
    const postCard = document.querySelector(`[data-post-id="${postId}"]`);
    if (!postCard) return;

    // Update like button and count
    const likeBtn = postCard.querySelector('.like-btn');
    const likeCount = postCard.querySelector('.like-count');
    if (likeBtn && likeCount) {
    likeCount.textContent = data.likeCount;
    if (data.userLiked) {
    likeBtn.classList.remove('btn-outline-success');
    likeBtn.classList.add('btn-success');
    } else {
    likeBtn.classList.remove('btn-success');
    likeBtn.classList.add('btn-outline-success');
    }
    }

    // Update dislike button and count
    const dislikeBtn = postCard.querySelector('.dislike-btn');
    const dislikeCount = postCard.querySelector('.dislike-count');
    if (dislikeBtn && dislikeCount) {
    dislikeCount.textContent = data.dislikeCount;
    if (data.userDisliked) {
    dislikeBtn.classList.remove('btn-outline-danger');
    dislikeBtn.classList.add('btn-danger');
    } else {
    dislikeBtn.classList.remove('btn-danger');
    dislikeBtn.classList.add('btn-outline-danger');
    }
    }
    }

    // ==== COMMENT FUNCTIONS ====

    // Toggle comments visibility
    window.toggleComments = async function(postId) {
    const commentsSection = document.getElementById(`comments-${postId}`);
    if (!commentsSection) return;

    if (commentsSection.style.display === 'none') {
    commentsSection.style.display = 'block';
    await loadComments(postId);
    } else {
    commentsSection.style.display = 'none';
    }
    };

    // Load comments for a post
    async function loadComments(postId) {
    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/comments`);
    if (!response.ok) throw new Error('Failed to load comments');

    const comments = await response.json();
    const commentList = document.getElementById(`comment-list-${postId}`);

    if (comments.length === 0) {
    commentList.innerHTML = '<p class="text-muted">No comments yet</p>';
    return;
    }

    commentList.innerHTML = comments.map(comment => {
    const commentDate = new Date(comment.createdAt);
    const timeAgo = getTimeAgo(commentDate);
    const profilePic = comment.userProfilePicture || 'images/default profile picture.jpg';
    const isOwnComment = currentUser && currentUser.id === comment.userId;
    const isAdmin = currentUser && currentUser.role === 'ADMIN';
    const canDeleteComment = isOwnComment || isAdmin;

    return `
    <div class="comment mb-3" data-comment-id="${comment.id}">
    <div class="d-flex align-items-start">
    <img src="${profilePic}" alt="User" width="40" height="40" 
    class="rounded-circle me-2" onerror="this.src='images/default profile picture.jpg'">
    <div class="flex-grow-1">
    <div>
    <strong>${comment.username}</strong>
    <span class="text-muted ms-2" style="font-size: 0.85rem;">${timeAgo}</span>
    </div>
    <p class="mb-1">${comment.commentText}</p>
    ${canDeleteComment ? `
    <button class="btn btn-sm btn-outline-danger" onclick="deleteComment(${comment.id}, ${postId})">
    Delete${isAdmin && !isOwnComment ? ' (Admin)' : ''}
    </button>
    ` : ''}
    </div>
    </div>
    </div>
    `;
    }).join('');
    } catch (error) {
    console.error('Error loading comments:', error);
    }
    }

    // Add a new comment
    window.addComment = async function(postId) {
    if (!currentUser) {
    alert('Please login to comment');
    return;
    }

    const input = document.getElementById(`comment-input-${postId}`);
    const commentText = input.value.trim();

    if (!commentText) {
    alert('Comment cannot be empty');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/comments?userId=${currentUser.id}`, {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json'
    },
    body: JSON.stringify({ commentText })
    });

    if (!response.ok) throw new Error('Failed to add comment');

    input.value = '';
    await loadComments(postId);

    // Update comment count
    const commentCount = document.querySelector(`[data-post-id="${postId}"] .comment-count`);
    if (commentCount) {
    commentCount.textContent = parseInt(commentCount.textContent) + 1;
    }
    } catch (error) {
    console.error('Error adding comment:', error);
    }
    };

    // Delete a comment
    window.deleteComment = async function(commentId, postId) {
    if (!currentUser) return;

    if (!confirm('Are you sure you want to delete this comment?')) return;

    try {
    const response = await fetch(`${API_BASE}/api/posts/comments/${commentId}?userId=${currentUser.id}`, {
    method: 'DELETE'
    });

    if (!response.ok) throw new Error('Failed to delete comment');

    await loadComments(postId);

    // Update comment count
    const commentCount = document.querySelector(`[data-post-id="${postId}"] .comment-count`);
    if (commentCount) {
    commentCount.textContent = Math.max(0, parseInt(commentCount.textContent) - 1);
    }
    } catch (error) {
    console.error('Error deleting comment:', error);
    }
    };

    // ==== FLAG POST FUNCTION ====

    window.flagPost = async function(postId, reason) {
    if (!currentUser) {
    alert('Please login to flag posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/flags?postId=${postId}&userId=${currentUser.id}&reason=${encodeURIComponent(reason)}`, {
    method: 'POST',
    credentials: 'include'
    });

    const data = await response.json();

    if (!response.ok) {
    throw new Error(data.message || 'Failed to flag post');
    }

    alert(`Post flagged as ${reason} successfully!`);
    loadUserPosts();

    } catch (error) {
    console.error('Error:', error);
    alert('Error: ' + error.message);
    }
    };

    // ==== EDIT POST FUNCTION ====

    window.editPost = function(postId, content) {
    console.log('Edit post:', postId, content);
    alert('Edit functionality coming soon!');
    };


      profilePreview.addEventListener('click', () => {
        if (!currentUser) {
          alert('Please login to change profile picture');
          return;
        }
        profilePicInput.click();
      });
    // ==== LIKE/DISLIKE FUNCTIONS ====

    // Toggle Like
    window.toggleLike = async function(postId) {
    if (!currentUser) {
    alert('Please login to like posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/like?userId=${currentUser.id}`, {
    method: 'POST'
    });

    if (!response.ok) throw new Error('Failed to toggle like');

    const data = await response.json();
    updatePostStats(postId, data);
    } catch (error) {
    console.error('Error toggling like:', error);
    }
    };

    // Toggle Dislike
    window.toggleDislike = async function(postId) {
    if (!currentUser) {
    alert('Please login to dislike posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/dislike?userId=${currentUser.id}`, {
    method: 'POST'
    });

    if (!response.ok) throw new Error('Failed to toggle dislike');

    const data = await response.json();
    updatePostStats(postId, data);
    } catch (error) {
    console.error('Error toggling dislike:', error);
    }
    };

    // Update post statistics in UI
    function updatePostStats(postId, data) {
    const postCard = document.querySelector(`[data-post-id="${postId}"]`);
    if (!postCard) return;

    // Update like button and count
    const likeBtn = postCard.querySelector('.like-btn');
    const likeCount = postCard.querySelector('.like-count');
    if (likeBtn && likeCount) {
    likeCount.textContent = data.likeCount;
    if (data.userLiked) {
    likeBtn.classList.remove('btn-outline-success');
    likeBtn.classList.add('btn-success');
    } else {
    likeBtn.classList.remove('btn-success');
    likeBtn.classList.add('btn-outline-success');
    }
    }

    // Update dislike button and count
    const dislikeBtn = postCard.querySelector('.dislike-btn');
    const dislikeCount = postCard.querySelector('.dislike-count');
    if (dislikeBtn && dislikeCount) {
    dislikeCount.textContent = data.dislikeCount;
    if (data.userDisliked) {
    dislikeBtn.classList.remove('btn-outline-danger');
    dislikeBtn.classList.add('btn-danger');
    } else {
    dislikeBtn.classList.remove('btn-danger');
    dislikeBtn.classList.add('btn-outline-danger');
    }
    }
    }

    // ==== COMMENT FUNCTIONS ====

    // Toggle comments visibility
    window.toggleComments = async function(postId) {
    const commentsSection = document.getElementById(`comments-${postId}`);
    if (!commentsSection) return;

    if (commentsSection.style.display === 'none') {
    commentsSection.style.display = 'block';
    await loadComments(postId);
    } else {
    commentsSection.style.display = 'none';
    }
    };

    // Load comments for a post
    async function loadComments(postId) {
    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/comments`);
    if (!response.ok) throw new Error('Failed to load comments');

    const comments = await response.json();
    const commentList = document.getElementById(`comment-list-${postId}`);

    if (comments.length === 0) {
    commentList.innerHTML = '<p class="text-muted">No comments yet</p>';
    return;
    }

    commentList.innerHTML = comments.map(comment => {
    const commentDate = new Date(comment.createdAt);
    const timeAgo = getTimeAgo(commentDate);
    const profilePic = comment.userProfilePicture || 'images/default profile picture.jpg';
    const isOwnComment = currentUser && currentUser.id === comment.userId;
    const isAdmin = currentUser && currentUser.role === 'ADMIN';
    const canDeleteComment = isOwnComment || isAdmin;

    return `
    <div class="comment mb-3" data-comment-id="${comment.id}">
    <div class="d-flex align-items-start">
    <img src="${profilePic}" alt="User" width="40" height="40" 
    class="rounded-circle me-2" onerror="this.src='images/default profile picture.jpg'">
    <div class="flex-grow-1">
    <div>
    <strong>${comment.username}</strong>
    <span class="text-muted ms-2" style="font-size: 0.85rem;">${timeAgo}</span>
    </div>
    <p class="mb-1">${comment.commentText}</p>
    ${canDeleteComment ? `
    <button class="btn btn-sm btn-outline-danger" onclick="deleteComment(${comment.id}, ${postId})">
    Delete${isAdmin && !isOwnComment ? ' (Admin)' : ''}
    </button>
    ` : ''}
    </div>
    </div>
    </div>
    `;
    }).join('');
    } catch (error) {
    console.error('Error loading comments:', error);
    }
    }

    // Add a new comment
    window.addComment = async function(postId) {
    if (!currentUser) {
    alert('Please login to comment');
    return;
    }

    const input = document.getElementById(`comment-input-${postId}`);
    const commentText = input.value.trim();

    if (!commentText) {
    alert('Comment cannot be empty');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/comments?userId=${currentUser.id}`, {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json'
    },
    body: JSON.stringify({ commentText })
    });

    if (!response.ok) throw new Error('Failed to add comment');

    input.value = '';
    await loadComments(postId);

    // Update comment count
    const commentCount = document.querySelector(`[data-post-id="${postId}"] .comment-count`);
    if (commentCount) {
    commentCount.textContent = parseInt(commentCount.textContent) + 1;
    }
    } catch (error) {
    console.error('Error adding comment:', error);
    }
    };

    // Delete a comment
    window.deleteComment = async function(commentId, postId) {
    if (!currentUser) return;

    if (!confirm('Are you sure you want to delete this comment?')) return;

    try {
    const response = await fetch(`${API_BASE}/api/posts/comments/${commentId}?userId=${currentUser.id}`, {
    method: 'DELETE'
    });

    if (!response.ok) throw new Error('Failed to delete comment');

    await loadComments(postId);

    // Update comment count
    const commentCount = document.querySelector(`[data-post-id="${postId}"] .comment-count`);
    if (commentCount) {
    commentCount.textContent = Math.max(0, parseInt(commentCount.textContent) - 1);
    }
    } catch (error) {
    console.error('Error deleting comment:', error);
    }
    };

    // ==== FLAG POST FUNCTION ====

    window.flagPost = async function(postId, reason) {
    if (!currentUser) {
    alert('Please login to flag posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/flags?postId=${postId}&userId=${currentUser.id}&reason=${encodeURIComponent(reason)}`, {
    method: 'POST',
    credentials: 'include'
    });

    const data = await response.json();

    if (!response.ok) {
    throw new Error(data.message || 'Failed to flag post');
    }

    alert(`Post flagged as ${reason} successfully!`);
    loadUserPosts();

    } catch (error) {
    console.error('Error:', error);
    alert('Error: ' + error.message);
    }
    };

    // ==== EDIT POST FUNCTION ====

    window.editPost = function(postId, content) {
    console.log('Edit post:', postId, content);
    alert('Edit functionality coming soon!');
    };


      profilePicInput.addEventListener('change', async (e) => {
        if (!currentUser) {
          alert('Please login to change profile picture');
          return;
        }
        
        const file = e.target.files[0];
        if (!file) return;

        console.log("[profile] Uploading file:", file.name, "Size:", file.size, "Type:", file.type);

        // Preview the image
        const reader = new FileReader();
        reader.onload = (e) => {
          profilePreview.src = e.target.result;
        };
        reader.readAsDataURL(file);

        // Upload to backend
        const formData = new FormData();
        formData.append('file', file);

        try {
          console.log("[profile] Sending request to:", `${API_BASE}/api/users/${currentUser.username}/profile-picture`);
          const res = await fetch(`${API_BASE}/api/users/${currentUser.username}/profile-picture`, {
            method: 'POST',
            body: formData
          });
    // ==== LIKE/DISLIKE FUNCTIONS ====

    // Toggle Like
    window.toggleLike = async function(postId) {
    if (!currentUser) {
    alert('Please login to like posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/like?userId=${currentUser.id}`, {
    method: 'POST'
    });

    if (!response.ok) throw new Error('Failed to toggle like');

    const data = await response.json();
    updatePostStats(postId, data);
    } catch (error) {
    console.error('Error toggling like:', error);
    }
    };

    // Toggle Dislike
    window.toggleDislike = async function(postId) {
    if (!currentUser) {
    alert('Please login to dislike posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/dislike?userId=${currentUser.id}`, {
    method: 'POST'
    });

    if (!response.ok) throw new Error('Failed to toggle dislike');

    const data = await response.json();
    updatePostStats(postId, data);
    } catch (error) {
    console.error('Error toggling dislike:', error);
    }
    };

    // Update post statistics in UI
    function updatePostStats(postId, data) {
    const postCard = document.querySelector(`[data-post-id="${postId}"]`);
    if (!postCard) return;

    // Update like button and count
    const likeBtn = postCard.querySelector('.like-btn');
    const likeCount = postCard.querySelector('.like-count');
    if (likeBtn && likeCount) {
    likeCount.textContent = data.likeCount;
    if (data.userLiked) {
    likeBtn.classList.remove('btn-outline-success');
    likeBtn.classList.add('btn-success');
    } else {
    likeBtn.classList.remove('btn-success');
    likeBtn.classList.add('btn-outline-success');
    }
    }

    // Update dislike button and count
    const dislikeBtn = postCard.querySelector('.dislike-btn');
    const dislikeCount = postCard.querySelector('.dislike-count');
    if (dislikeBtn && dislikeCount) {
    dislikeCount.textContent = data.dislikeCount;
    if (data.userDisliked) {
    dislikeBtn.classList.remove('btn-outline-danger');
    dislikeBtn.classList.add('btn-danger');
    } else {
    dislikeBtn.classList.remove('btn-danger');
    dislikeBtn.classList.add('btn-outline-danger');
    }
    }
    }

    // ==== COMMENT FUNCTIONS ====

    // Toggle comments visibility
    window.toggleComments = async function(postId) {
    const commentsSection = document.getElementById(`comments-${postId}`);
    if (!commentsSection) return;

    if (commentsSection.style.display === 'none') {
    commentsSection.style.display = 'block';
    await loadComments(postId);
    } else {
    commentsSection.style.display = 'none';
    }
    };

    // Load comments for a post
    async function loadComments(postId) {
    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/comments`);
    if (!response.ok) throw new Error('Failed to load comments');

    const comments = await response.json();
    const commentList = document.getElementById(`comment-list-${postId}`);

    if (comments.length === 0) {
    commentList.innerHTML = '<p class="text-muted">No comments yet</p>';
    return;
    }

    commentList.innerHTML = comments.map(comment => {
    const commentDate = new Date(comment.createdAt);
    const timeAgo = getTimeAgo(commentDate);
    const profilePic = comment.userProfilePicture || 'images/default profile picture.jpg';
    const isOwnComment = currentUser && currentUser.id === comment.userId;
    const isAdmin = currentUser && currentUser.role === 'ADMIN';
    const canDeleteComment = isOwnComment || isAdmin;

    return `
    <div class="comment mb-3" data-comment-id="${comment.id}">
    <div class="d-flex align-items-start">
    <img src="${profilePic}" alt="User" width="40" height="40" 
    class="rounded-circle me-2" onerror="this.src='images/default profile picture.jpg'">
    <div class="flex-grow-1">
    <div>
    <strong>${comment.username}</strong>
    <span class="text-muted ms-2" style="font-size: 0.85rem;">${timeAgo}</span>
    </div>
    <p class="mb-1">${comment.commentText}</p>
    ${canDeleteComment ? `
    <button class="btn btn-sm btn-outline-danger" onclick="deleteComment(${comment.id}, ${postId})">
    Delete${isAdmin && !isOwnComment ? ' (Admin)' : ''}
    </button>
    ` : ''}
    </div>
    </div>
    </div>
    `;
    }).join('');
    } catch (error) {
    console.error('Error loading comments:', error);
    }
    }

    // Add a new comment
    window.addComment = async function(postId) {
    if (!currentUser) {
    alert('Please login to comment');
    return;
    }

    const input = document.getElementById(`comment-input-${postId}`);
    const commentText = input.value.trim();

    if (!commentText) {
    alert('Comment cannot be empty');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/comments?userId=${currentUser.id}`, {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json'
    },
    body: JSON.stringify({ commentText })
    });

    if (!response.ok) throw new Error('Failed to add comment');

    input.value = '';
    await loadComments(postId);

    // Update comment count
    const commentCount = document.querySelector(`[data-post-id="${postId}"] .comment-count`);
    if (commentCount) {
    commentCount.textContent = parseInt(commentCount.textContent) + 1;
    }
    } catch (error) {
    console.error('Error adding comment:', error);
    }
    };

    // Delete a comment
    window.deleteComment = async function(commentId, postId) {
    if (!currentUser) return;

    if (!confirm('Are you sure you want to delete this comment?')) return;

    try {
    const response = await fetch(`${API_BASE}/api/posts/comments/${commentId}?userId=${currentUser.id}`, {
    method: 'DELETE'
    });

    if (!response.ok) throw new Error('Failed to delete comment');

    await loadComments(postId);

    // Update comment count
    const commentCount = document.querySelector(`[data-post-id="${postId}"] .comment-count`);
    if (commentCount) {
    commentCount.textContent = Math.max(0, parseInt(commentCount.textContent) - 1);
    }
    } catch (error) {
    console.error('Error deleting comment:', error);
    }
    };

    // ==== FLAG POST FUNCTION ====

    window.flagPost = async function(postId, reason) {
    if (!currentUser) {
    alert('Please login to flag posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/flags?postId=${postId}&userId=${currentUser.id}&reason=${encodeURIComponent(reason)}`, {
    method: 'POST',
    credentials: 'include'
    });

    const data = await response.json();

    if (!response.ok) {
    throw new Error(data.message || 'Failed to flag post');
    }

    alert(`Post flagged as ${reason} successfully!`);
    loadUserPosts();

    } catch (error) {
    console.error('Error:', error);
    alert('Error: ' + error.message);
    }
    };

    // ==== EDIT POST FUNCTION ====

    window.editPost = function(postId, content) {
    console.log('Edit post:', postId, content);
    alert('Edit functionality coming soon!');
    };


          console.log("[profile] Response status:", res.status);

          if (res.ok) {
            const data = await res.json();
            console.log("[profile] Upload successful:", data);
            currentUser.profilePictureUrl = data.profilePictureUrl;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            alert('Profile picture updated successfully!');
            location.reload(); // Reload to show new picture
          } else {
            const errorText = await res.text();
            console.error('[profile] Upload failed:', res.status, errorText);
            alert('Failed to upload profile picture: ' + res.status);
          }
        } catch (error) {
          console.error('[profile] Error uploading profile picture:', error);
          alert('Error uploading profile picture: ' + error.message);
        }
      });
    // ==== LIKE/DISLIKE FUNCTIONS ====

    // Toggle Like
    window.toggleLike = async function(postId) {
    if (!currentUser) {
    alert('Please login to like posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/like?userId=${currentUser.id}`, {
    method: 'POST'
    });

    if (!response.ok) throw new Error('Failed to toggle like');

    const data = await response.json();
    updatePostStats(postId, data);
    } catch (error) {
    console.error('Error toggling like:', error);
    }
    };

    // Toggle Dislike
    window.toggleDislike = async function(postId) {
    if (!currentUser) {
    alert('Please login to dislike posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/dislike?userId=${currentUser.id}`, {
    method: 'POST'
    });

    if (!response.ok) throw new Error('Failed to toggle dislike');

    const data = await response.json();
    updatePostStats(postId, data);
    } catch (error) {
    console.error('Error toggling dislike:', error);
    }
    };

    // Update post statistics in UI
    function updatePostStats(postId, data) {
    const postCard = document.querySelector(`[data-post-id="${postId}"]`);
    if (!postCard) return;

    // Update like button and count
    const likeBtn = postCard.querySelector('.like-btn');
    const likeCount = postCard.querySelector('.like-count');
    if (likeBtn && likeCount) {
    likeCount.textContent = data.likeCount;
    if (data.userLiked) {
    likeBtn.classList.remove('btn-outline-success');
    likeBtn.classList.add('btn-success');
    } else {
    likeBtn.classList.remove('btn-success');
    likeBtn.classList.add('btn-outline-success');
    }
    }

    // Update dislike button and count
    const dislikeBtn = postCard.querySelector('.dislike-btn');
    const dislikeCount = postCard.querySelector('.dislike-count');
    if (dislikeBtn && dislikeCount) {
    dislikeCount.textContent = data.dislikeCount;
    if (data.userDisliked) {
    dislikeBtn.classList.remove('btn-outline-danger');
    dislikeBtn.classList.add('btn-danger');
    } else {
    dislikeBtn.classList.remove('btn-danger');
    dislikeBtn.classList.add('btn-outline-danger');
    }
    }
    }

    // ==== COMMENT FUNCTIONS ====

    // Toggle comments visibility
    window.toggleComments = async function(postId) {
    const commentsSection = document.getElementById(`comments-${postId}`);
    if (!commentsSection) return;

    if (commentsSection.style.display === 'none') {
    commentsSection.style.display = 'block';
    await loadComments(postId);
    } else {
    commentsSection.style.display = 'none';
    }
    };

    // Load comments for a post
    async function loadComments(postId) {
    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/comments`);
    if (!response.ok) throw new Error('Failed to load comments');

    const comments = await response.json();
    const commentList = document.getElementById(`comment-list-${postId}`);

    if (comments.length === 0) {
    commentList.innerHTML = '<p class="text-muted">No comments yet</p>';
    return;
    }

    commentList.innerHTML = comments.map(comment => {
    const commentDate = new Date(comment.createdAt);
    const timeAgo = getTimeAgo(commentDate);
    const profilePic = comment.userProfilePicture || 'images/default profile picture.jpg';
    const isOwnComment = currentUser && currentUser.id === comment.userId;
    const isAdmin = currentUser && currentUser.role === 'ADMIN';
    const canDeleteComment = isOwnComment || isAdmin;

    return `
    <div class="comment mb-3" data-comment-id="${comment.id}">
    <div class="d-flex align-items-start">
    <img src="${profilePic}" alt="User" width="40" height="40" 
    class="rounded-circle me-2" onerror="this.src='images/default profile picture.jpg'">
    <div class="flex-grow-1">
    <div>
    <strong>${comment.username}</strong>
    <span class="text-muted ms-2" style="font-size: 0.85rem;">${timeAgo}</span>
    </div>
    <p class="mb-1">${comment.commentText}</p>
    ${canDeleteComment ? `
    <button class="btn btn-sm btn-outline-danger" onclick="deleteComment(${comment.id}, ${postId})">
    Delete${isAdmin && !isOwnComment ? ' (Admin)' : ''}
    </button>
    ` : ''}
    </div>
    </div>
    </div>
    `;
    }).join('');
    } catch (error) {
    console.error('Error loading comments:', error);
    }
    }

    // Add a new comment
    window.addComment = async function(postId) {
    if (!currentUser) {
    alert('Please login to comment');
    return;
    }

    const input = document.getElementById(`comment-input-${postId}`);
    const commentText = input.value.trim();

    if (!commentText) {
    alert('Comment cannot be empty');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/comments?userId=${currentUser.id}`, {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json'
    },
    body: JSON.stringify({ commentText })
    });

    if (!response.ok) throw new Error('Failed to add comment');

    input.value = '';
    await loadComments(postId);

    // Update comment count
    const commentCount = document.querySelector(`[data-post-id="${postId}"] .comment-count`);
    if (commentCount) {
    commentCount.textContent = parseInt(commentCount.textContent) + 1;
    }
    } catch (error) {
    console.error('Error adding comment:', error);
    }
    };

    // Delete a comment
    window.deleteComment = async function(commentId, postId) {
    if (!currentUser) return;

    if (!confirm('Are you sure you want to delete this comment?')) return;

    try {
    const response = await fetch(`${API_BASE}/api/posts/comments/${commentId}?userId=${currentUser.id}`, {
    method: 'DELETE'
    });

    if (!response.ok) throw new Error('Failed to delete comment');

    await loadComments(postId);

    // Update comment count
    const commentCount = document.querySelector(`[data-post-id="${postId}"] .comment-count`);
    if (commentCount) {
    commentCount.textContent = Math.max(0, parseInt(commentCount.textContent) - 1);
    }
    } catch (error) {
    console.error('Error deleting comment:', error);
    }
    };

    // ==== FLAG POST FUNCTION ====

    window.flagPost = async function(postId, reason) {
    if (!currentUser) {
    alert('Please login to flag posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/flags?postId=${postId}&userId=${currentUser.id}&reason=${encodeURIComponent(reason)}`, {
    method: 'POST',
    credentials: 'include'
    });

    const data = await response.json();

    if (!response.ok) {
    throw new Error(data.message || 'Failed to flag post');
    }

    alert(`Post flagged as ${reason} successfully!`);
    loadUserPosts();

    } catch (error) {
    console.error('Error:', error);
    alert('Error: ' + error.message);
    }
    };

    // ==== EDIT POST FUNCTION ====

    window.editPost = function(postId, content) {
    console.log('Edit post:', postId, content);
    alert('Edit functionality coming soon!');
    };


      // Load user's posts (only if logged in)
      async function loadUserPosts() {
        if (!currentUser) {
          document.getElementById('userPosts').innerHTML = '<p class="text-center text-muted">Please login to view your posts</p>';
          return;
        }
        
        try {
          const res = await fetch(`${API_BASE}/api/posts/user/${currentUser.id}`);
          if (!res.ok) throw new Error('Failed to load posts');
          
          const posts = await res.json();
          const postsContainer = document.getElementById('userPosts');
          
          if (posts.length === 0) {
            postsContainer.innerHTML = '<p class="text-center text-muted">No posts yet. Create your first post above!</p>';
            return;
          }

          postsContainer.innerHTML = posts.map(post => {
            const postDate = new Date(post.createdAt);
            const timeAgo = getTimeAgo(postDate);

            return `
              <div class="card mb-3" data-post-id="${post.id}">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-start">
                    <span class="post-timestamp">${timeAgo}</span>
                  </div>
                  ${post.content ? `<p class="mt-2">${post.content}</p>` : ''}
                  ${post.imageUrl ? `<img src="${API_BASE}${post.imageUrl}" class="post-image" alt="post image">` : ''}

                  <!-- Post Actions -->
                  <div class="post-actions mt-3">
                    <button class="btn btn-sm btn-outline-success like-btn" onclick="toggleLike(${post.id})">
                      üëç Like (<span class="like-count">${post.likeCount || 0}</span>)
                    </button>
                    <button class="btn btn-sm btn-outline-danger dislike-btn" onclick="toggleDislike(${post.id})">
                      üëé Dislike (<span class="dislike-count">${post.dislikeCount || 0}</span>)
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleComments(${post.id})">
                      üí¨ Comment (<span class="comment-count">${post.commentCount || 0}</span>)
                    </button>
                    <button class="btn btn-sm btn-outline-primary edit-post-btn">
                      ‚úèÔ∏è Edit
                    </button>
                    <button class="btn btn-sm btn-outline-dark delete-post-btn" onclick="deletePost(${post.id})">
                      üóëÔ∏è Delete
                    </button>
                  </div>

                  <!-- Comment Section -->
                  <div class="comment-section mt-3" id="comments-${post.id}" style="display: none;">
                    <div class="d-flex align-items-center mb-3">
                      <input type="text" class="form-control form-control-sm me-2" 
                             id="comment-input-${post.id}" placeholder="Write a comment...">
                      <button class="btn btn-sm btn-primary" onclick="addComment(${post.id})">Post</button>
                    </div>
                    <div id="comment-list-${post.id}"></div>
                  </div>
                </div>
              </div>
            `;
          }).join('');
          
        } catch (error) {
          console.error('Error loading posts:', error);
          document.getElementById('userPosts').innerHTML = '<p class="text-center text-danger">Failed to load posts</p>';
        }
      }

      function getTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        
        let interval = seconds / 31536000;
        if (interval > 1) return Math.floor(interval) + " years ago";
        
        interval = seconds / 2592000;
        if (interval > 1) return Math.floor(interval) + " months ago";
        
        interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + " days ago";
        
        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + " hours ago";
        
        interval = seconds / 60;
        if (interval > 1) return Math.floor(interval) + " minutes ago";
        
        return "Just now";
      }

      // Make deletePost global
      window.deletePost = async function(postId) {
        if (!currentUser) {
          alert('Please login to delete posts');
          return;
        }
        
        if (!confirm('Are you sure you want to delete this post?')) return;
        
        try {
          const res = await fetch(`${API_BASE}/api/posts/${postId}?userId=${currentUser.id}`, {
            method: 'DELETE'
          });
    // ==== LIKE/DISLIKE FUNCTIONS ====

    // Toggle Like
    window.toggleLike = async function(postId) {
    if (!currentUser) {
    alert('Please login to like posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/like?userId=${currentUser.id}`, {
    method: 'POST'
    });

    if (!response.ok) throw new Error('Failed to toggle like');

    const data = await response.json();
    updatePostStats(postId, data);
    } catch (error) {
    console.error('Error toggling like:', error);
    }
    };

      // Toggle comments section
      window.toggleComments = async function(postId) {
        const commentsSection = document.getElementById('comments-' + postId);
        if (!commentsSection) return;

        if (commentsSection.style.display === 'none') {
          commentsSection.style.display = 'block';
          await loadComments(postId);
        } else {
          commentsSection.style.display = 'none';
        }
      };


    // Toggle Dislike
    window.toggleDislike = async function(postId) {
    if (!currentUser) {
    alert('Please login to dislike posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/dislike?userId=${currentUser.id}`, {
    method: 'POST'
    });

    if (!response.ok) throw new Error('Failed to toggle dislike');

    const data = await response.json();
    updatePostStats(postId, data);
    } catch (error) {
    console.error('Error toggling dislike:', error);
    }
    };

    // Update post statistics in UI
    function updatePostStats(postId, data) {
    const postCard = document.querySelector(`[data-post-id="${postId}"]`);
    if (!postCard) return;

    // Update like button and count
    const likeBtn = postCard.querySelector('.like-btn');
    const likeCount = postCard.querySelector('.like-count');
    if (likeBtn && likeCount) {
    likeCount.textContent = data.likeCount;
    if (data.userLiked) {
    likeBtn.classList.remove('btn-outline-success');
    likeBtn.classList.add('btn-success');
    } else {
    likeBtn.classList.remove('btn-success');
    likeBtn.classList.add('btn-outline-success');
    }
    }

    // Update dislike button and count
    const dislikeBtn = postCard.querySelector('.dislike-btn');
    const dislikeCount = postCard.querySelector('.dislike-count');
    if (dislikeBtn && dislikeCount) {
    dislikeCount.textContent = data.dislikeCount;
    if (data.userDisliked) {
    dislikeBtn.classList.remove('btn-outline-danger');
    dislikeBtn.classList.add('btn-danger');
    } else {
    dislikeBtn.classList.remove('btn-danger');
    dislikeBtn.classList.add('btn-outline-danger');
    }
    }
    }

    // ==== COMMENT FUNCTIONS ====

    // Toggle comments visibility
    window.toggleComments = async function(postId) {
    const commentsSection = document.getElementById(`comments-${postId}`);
    if (!commentsSection) return;

    if (commentsSection.style.display === 'none') {
    commentsSection.style.display = 'block';
    await loadComments(postId);
    } else {
    commentsSection.style.display = 'none';
    }
    };

    // Load comments for a post
    async function loadComments(postId) {
    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/comments`);
    if (!response.ok) throw new Error('Failed to load comments');

    const comments = await response.json();
    const commentList = document.getElementById(`comment-list-${postId}`);

    if (comments.length === 0) {
    commentList.innerHTML = '<p class="text-muted">No comments yet</p>';
    return;
    }

    commentList.innerHTML = comments.map(comment => {
    const commentDate = new Date(comment.createdAt);
    const timeAgo = getTimeAgo(commentDate);
    const profilePic = comment.userProfilePicture || 'images/default profile picture.jpg';
    const isOwnComment = currentUser && currentUser.id === comment.userId;
    const isAdmin = currentUser && currentUser.role === 'ADMIN';
    const canDeleteComment = isOwnComment || isAdmin;

    return `
    <div class="comment mb-3" data-comment-id="${comment.id}">
    <div class="d-flex align-items-start">
    <img src="${profilePic}" alt="User" width="40" height="40" 
    class="rounded-circle me-2" onerror="this.src='images/default profile picture.jpg'">
    <div class="flex-grow-1">
    <div>
    <strong>${comment.username}</strong>
    <span class="text-muted ms-2" style="font-size: 0.85rem;">${timeAgo}</span>
    </div>
    <p class="mb-1">${comment.commentText}</p>
    ${canDeleteComment ? `
    <button class="btn btn-sm btn-outline-danger" onclick="deleteComment(${comment.id}, ${postId})">
    Delete${isAdmin && !isOwnComment ? ' (Admin)' : ''}
    </button>
    ` : ''}
    </div>
    </div>
    </div>
    `;
    }).join('');
    } catch (error) {
    console.error('Error loading comments:', error);
    }
    }

    // Add a new comment
    window.addComment = async function(postId) {
    if (!currentUser) {
    alert('Please login to comment');
    return;
    }

    const input = document.getElementById(`comment-input-${postId}`);
    const commentText = input.value.trim();

    if (!commentText) {
    alert('Comment cannot be empty');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/comments?userId=${currentUser.id}`, {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json'
    },
    body: JSON.stringify({ commentText })
    });

    if (!response.ok) throw new Error('Failed to add comment');

    input.value = '';
    await loadComments(postId);

    // Update comment count
    const commentCount = document.querySelector(`[data-post-id="${postId}"] .comment-count`);
    if (commentCount) {
    commentCount.textContent = parseInt(commentCount.textContent) + 1;
    }
    } catch (error) {
    console.error('Error adding comment:', error);
    }
    };

    // Delete a comment
    window.deleteComment = async function(commentId, postId) {
    if (!currentUser) return;

    if (!confirm('Are you sure you want to delete this comment?')) return;

    try {
    const response = await fetch(`${API_BASE}/api/posts/comments/${commentId}?userId=${currentUser.id}`, {
    method: 'DELETE'
    });

    if (!response.ok) throw new Error('Failed to delete comment');

    await loadComments(postId);

    // Update comment count
    const commentCount = document.querySelector(`[data-post-id="${postId}"] .comment-count`);
    if (commentCount) {
    commentCount.textContent = Math.max(0, parseInt(commentCount.textContent) - 1);
    }
    } catch (error) {
    console.error('Error deleting comment:', error);
    }
    };

    // ==== FLAG POST FUNCTION ====

    window.flagPost = async function(postId, reason) {
    if (!currentUser) {
    alert('Please login to flag posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/flags?postId=${postId}&userId=${currentUser.id}&reason=${encodeURIComponent(reason)}`, {
    method: 'POST',
    credentials: 'include'
    });

    const data = await response.json();

    if (!response.ok) {
    throw new Error(data.message || 'Failed to flag post');
    }

    alert(`Post flagged as ${reason} successfully!`);
    loadUserPosts();

    } catch (error) {
    console.error('Error:', error);
    alert('Error: ' + error.message);
    }
    };

    // ==== EDIT POST FUNCTION ====

    window.editPost = function(postId, content) {
    console.log('Edit post:', postId, content);
    alert('Edit functionality coming soon!');
    };

          
          if (res.ok) {
            alert('Post deleted successfully!');
            loadUserPosts();
          } else {
            alert('Failed to delete post');
          }
        } catch (error) {
          console.error('Error deleting post:', error);
          alert('Error deleting post');
        }
      };

      loadUserPosts();
 
      // Edit Profile
      editBtn.addEventListener('click', () => {
        if (!currentUser) {
          alert('Please login to edit profile');
          return;
        }
        
        displayMajor.style.display = 'none';
        displayMinor.style.display = 'none';
        displayYear.style.display = 'none';
        displayBio.style.display = 'none';
 
        majorInput.value = currentUser.major || '';
        minorInput.value = currentUser.minor || '';
        graduationYearSelect.value = currentUser.graduationYear || '';
        bioInput.value = currentUser.bio || '';
 
        majorInput.style.display = 'block';
        minorInput.style.display = 'block';
        graduationYearSelect.style.display = 'block';
        bioInput.style.display = 'block';
 
        editBtn.style.display = 'none';
        saveBtn.style.display = 'block';
      });
    // ==== LIKE/DISLIKE FUNCTIONS ====

    // Toggle Like
    window.toggleLike = async function(postId) {
    if (!currentUser) {
    alert('Please login to like posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/like?userId=${currentUser.id}`, {
    method: 'POST'
    });

    if (!response.ok) throw new Error('Failed to toggle like');

    const data = await response.json();
    updatePostStats(postId, data);
    } catch (error) {
    console.error('Error toggling like:', error);
    }
    };

    // Toggle Dislike
    window.toggleDislike = async function(postId) {
    if (!currentUser) {
    alert('Please login to dislike posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/dislike?userId=${currentUser.id}`, {
    method: 'POST'
    });

    if (!response.ok) throw new Error('Failed to toggle dislike');

    const data = await response.json();
    updatePostStats(postId, data);
    } catch (error) {
    console.error('Error toggling dislike:', error);
    }
    };

    // Update post statistics in UI
    function updatePostStats(postId, data) {
    const postCard = document.querySelector(`[data-post-id="${postId}"]`);
    if (!postCard) return;

    // Update like button and count
    const likeBtn = postCard.querySelector('.like-btn');
    const likeCount = postCard.querySelector('.like-count');
    if (likeBtn && likeCount) {
    likeCount.textContent = data.likeCount;
    if (data.userLiked) {
    likeBtn.classList.remove('btn-outline-success');
    likeBtn.classList.add('btn-success');
    } else {
    likeBtn.classList.remove('btn-success');
    likeBtn.classList.add('btn-outline-success');
    }
    }

    // Update dislike button and count
    const dislikeBtn = postCard.querySelector('.dislike-btn');
    const dislikeCount = postCard.querySelector('.dislike-count');
    if (dislikeBtn && dislikeCount) {
    dislikeCount.textContent = data.dislikeCount;
    if (data.userDisliked) {
    dislikeBtn.classList.remove('btn-outline-danger');
    dislikeBtn.classList.add('btn-danger');
    } else {
    dislikeBtn.classList.remove('btn-danger');
    dislikeBtn.classList.add('btn-outline-danger');
    }
    }
    }

    // ==== COMMENT FUNCTIONS ====

    // Toggle comments visibility
    window.toggleComments = async function(postId) {
    const commentsSection = document.getElementById(`comments-${postId}`);
    if (!commentsSection) return;

    if (commentsSection.style.display === 'none') {
    commentsSection.style.display = 'block';
    await loadComments(postId);
    } else {
    commentsSection.style.display = 'none';
    }
    };

    // Load comments for a post
    async function loadComments(postId) {
    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/comments`);
    if (!response.ok) throw new Error('Failed to load comments');

    const comments = await response.json();
    const commentList = document.getElementById(`comment-list-${postId}`);

    if (comments.length === 0) {
    commentList.innerHTML = '<p class="text-muted">No comments yet</p>';
    return;
    }

    commentList.innerHTML = comments.map(comment => {
    const commentDate = new Date(comment.createdAt);
    const timeAgo = getTimeAgo(commentDate);
    const profilePic = comment.userProfilePicture || 'images/default profile picture.jpg';
    const isOwnComment = currentUser && currentUser.id === comment.userId;
    const isAdmin = currentUser && currentUser.role === 'ADMIN';
    const canDeleteComment = isOwnComment || isAdmin;

    return `
    <div class="comment mb-3" data-comment-id="${comment.id}">
    <div class="d-flex align-items-start">
    <img src="${profilePic}" alt="User" width="40" height="40" 
    class="rounded-circle me-2" onerror="this.src='images/default profile picture.jpg'">
    <div class="flex-grow-1">
    <div>
    <strong>${comment.username}</strong>
    <span class="text-muted ms-2" style="font-size: 0.85rem;">${timeAgo}</span>
    </div>
    <p class="mb-1">${comment.commentText}</p>
    ${canDeleteComment ? `
    <button class="btn btn-sm btn-outline-danger" onclick="deleteComment(${comment.id}, ${postId})">
    Delete${isAdmin && !isOwnComment ? ' (Admin)' : ''}
    </button>
    ` : ''}
    </div>
    </div>
    </div>
    `;
    }).join('');
    } catch (error) {
    console.error('Error loading comments:', error);
    }
    }

    // Add a new comment
    window.addComment = async function(postId) {
    if (!currentUser) {
    alert('Please login to comment');
    return;
    }

    const input = document.getElementById(`comment-input-${postId}`);
    const commentText = input.value.trim();

    if (!commentText) {
    alert('Comment cannot be empty');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/comments?userId=${currentUser.id}`, {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json'
    },
    body: JSON.stringify({ commentText })
    });

    if (!response.ok) throw new Error('Failed to add comment');

    input.value = '';
    await loadComments(postId);

    // Update comment count
    const commentCount = document.querySelector(`[data-post-id="${postId}"] .comment-count`);
    if (commentCount) {
    commentCount.textContent = parseInt(commentCount.textContent) + 1;
    }
    } catch (error) {
    console.error('Error adding comment:', error);
    }
    };

    // Delete a comment
    window.deleteComment = async function(commentId, postId) {
    if (!currentUser) return;

    if (!confirm('Are you sure you want to delete this comment?')) return;

    try {
    const response = await fetch(`${API_BASE}/api/posts/comments/${commentId}?userId=${currentUser.id}`, {
    method: 'DELETE'
    });

    if (!response.ok) throw new Error('Failed to delete comment');

    await loadComments(postId);

    // Update comment count
    const commentCount = document.querySelector(`[data-post-id="${postId}"] .comment-count`);
    if (commentCount) {
    commentCount.textContent = Math.max(0, parseInt(commentCount.textContent) - 1);
    }
    } catch (error) {
    console.error('Error deleting comment:', error);
    }
    };

    // ==== FLAG POST FUNCTION ====

    window.flagPost = async function(postId, reason) {
    if (!currentUser) {
    alert('Please login to flag posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/flags?postId=${postId}&userId=${currentUser.id}&reason=${encodeURIComponent(reason)}`, {
    method: 'POST',
    credentials: 'include'
    });

    const data = await response.json();

    if (!response.ok) {
    throw new Error(data.message || 'Failed to flag post');
    }

    alert(`Post flagged as ${reason} successfully!`);
    loadUserPosts();

    } catch (error) {
    console.error('Error:', error);
    alert('Error: ' + error.message);
    }
    };

    // ==== EDIT POST FUNCTION ====

    window.editPost = function(postId, content) {
    console.log('Edit post:', postId, content);
    alert('Edit functionality coming soon!');
    };

 
      // Save Profile changes
      saveBtn.addEventListener('click', async () => {
        if (!currentUser) {
          alert('Please login to save profile');
          return;
        }
        
        const updatedData = {
          bio: bioInput.value.trim(),
          major: majorInput.value.trim(),
          minor: minorInput.value.trim(),
          graduationYear: graduationYearSelect.value ? parseInt(graduationYearSelect.value) : null
        };

        try {
          const res = await fetch(`${API_BASE}/api/users/${currentUser.username}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updatedData)
          });
    // ==== LIKE/DISLIKE FUNCTIONS ====

    // Toggle Like
    window.toggleLike = async function(postId) {
    if (!currentUser) {
    alert('Please login to like posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/like?userId=${currentUser.id}`, {
    method: 'POST'
    });

    if (!response.ok) throw new Error('Failed to toggle like');

    const data = await response.json();
    updatePostStats(postId, data);
    } catch (error) {
    console.error('Error toggling like:', error);
    }
    };

    // Toggle Dislike
    window.toggleDislike = async function(postId) {
    if (!currentUser) {
    alert('Please login to dislike posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/dislike?userId=${currentUser.id}`, {
    method: 'POST'
    });

    if (!response.ok) throw new Error('Failed to toggle dislike');

    const data = await response.json();
    updatePostStats(postId, data);
    } catch (error) {
    console.error('Error toggling dislike:', error);
    }
    };

    // Update post statistics in UI
    function updatePostStats(postId, data) {
    const postCard = document.querySelector(`[data-post-id="${postId}"]`);
    if (!postCard) return;

    // Update like button and count
    const likeBtn = postCard.querySelector('.like-btn');
    const likeCount = postCard.querySelector('.like-count');
    if (likeBtn && likeCount) {
    likeCount.textContent = data.likeCount;
    if (data.userLiked) {
    likeBtn.classList.remove('btn-outline-success');
    likeBtn.classList.add('btn-success');
    } else {
    likeBtn.classList.remove('btn-success');
    likeBtn.classList.add('btn-outline-success');
    }
    }

    // Update dislike button and count
    const dislikeBtn = postCard.querySelector('.dislike-btn');
    const dislikeCount = postCard.querySelector('.dislike-count');
    if (dislikeBtn && dislikeCount) {
    dislikeCount.textContent = data.dislikeCount;
    if (data.userDisliked) {
    dislikeBtn.classList.remove('btn-outline-danger');
    dislikeBtn.classList.add('btn-danger');
    } else {
    dislikeBtn.classList.remove('btn-danger');
    dislikeBtn.classList.add('btn-outline-danger');
    }
    }
    }

    // ==== COMMENT FUNCTIONS ====

    // Toggle comments visibility
    window.toggleComments = async function(postId) {
    const commentsSection = document.getElementById(`comments-${postId}`);
    if (!commentsSection) return;

    if (commentsSection.style.display === 'none') {
    commentsSection.style.display = 'block';
    await loadComments(postId);
    } else {
    commentsSection.style.display = 'none';
    }
    };

    // Load comments for a post
    async function loadComments(postId) {
    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/comments`);
    if (!response.ok) throw new Error('Failed to load comments');

    const comments = await response.json();
    const commentList = document.getElementById(`comment-list-${postId}`);

    if (comments.length === 0) {
    commentList.innerHTML = '<p class="text-muted">No comments yet</p>';
    return;
    }

    commentList.innerHTML = comments.map(comment => {
    const commentDate = new Date(comment.createdAt);
    const timeAgo = getTimeAgo(commentDate);
    const profilePic = comment.userProfilePicture || 'images/default profile picture.jpg';
    const isOwnComment = currentUser && currentUser.id === comment.userId;
    const isAdmin = currentUser && currentUser.role === 'ADMIN';
    const canDeleteComment = isOwnComment || isAdmin;

    return `
    <div class="comment mb-3" data-comment-id="${comment.id}">
    <div class="d-flex align-items-start">
    <img src="${profilePic}" alt="User" width="40" height="40" 
    class="rounded-circle me-2" onerror="this.src='images/default profile picture.jpg'">
    <div class="flex-grow-1">
    <div>
    <strong>${comment.username}</strong>
    <span class="text-muted ms-2" style="font-size: 0.85rem;">${timeAgo}</span>
    </div>
    <p class="mb-1">${comment.commentText}</p>
    ${canDeleteComment ? `
    <button class="btn btn-sm btn-outline-danger" onclick="deleteComment(${comment.id}, ${postId})">
    Delete${isAdmin && !isOwnComment ? ' (Admin)' : ''}
    </button>
    ` : ''}
    </div>
    </div>
    </div>
    `;
    }).join('');
    } catch (error) {
    console.error('Error loading comments:', error);
    }
    }

    // Add a new comment
    window.addComment = async function(postId) {
    if (!currentUser) {
    alert('Please login to comment');
    return;
    }

    const input = document.getElementById(`comment-input-${postId}`);
    const commentText = input.value.trim();

    if (!commentText) {
    alert('Comment cannot be empty');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/comments?userId=${currentUser.id}`, {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json'
    },
    body: JSON.stringify({ commentText })
    });

    if (!response.ok) throw new Error('Failed to add comment');

    input.value = '';
    await loadComments(postId);

    // Update comment count
    const commentCount = document.querySelector(`[data-post-id="${postId}"] .comment-count`);
    if (commentCount) {
    commentCount.textContent = parseInt(commentCount.textContent) + 1;
    }
    } catch (error) {
    console.error('Error adding comment:', error);
    }
    };

    // Delete a comment
    window.deleteComment = async function(commentId, postId) {
    if (!currentUser) return;

    if (!confirm('Are you sure you want to delete this comment?')) return;

    try {
    const response = await fetch(`${API_BASE}/api/posts/comments/${commentId}?userId=${currentUser.id}`, {
    method: 'DELETE'
    });

    if (!response.ok) throw new Error('Failed to delete comment');

    await loadComments(postId);

    // Update comment count
    const commentCount = document.querySelector(`[data-post-id="${postId}"] .comment-count`);
    if (commentCount) {
    commentCount.textContent = Math.max(0, parseInt(commentCount.textContent) - 1);
    }
    } catch (error) {
    console.error('Error deleting comment:', error);
    }
    };

    // ==== FLAG POST FUNCTION ====

    window.flagPost = async function(postId, reason) {
    if (!currentUser) {
    alert('Please login to flag posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/flags?postId=${postId}&userId=${currentUser.id}&reason=${encodeURIComponent(reason)}`, {
    method: 'POST',
    credentials: 'include'
    });

    const data = await response.json();

    if (!response.ok) {
    throw new Error(data.message || 'Failed to flag post');
    }

    alert(`Post flagged as ${reason} successfully!`);
    loadUserPosts();

    } catch (error) {
    console.error('Error:', error);
    alert('Error: ' + error.message);
    }
    };

    // ==== EDIT POST FUNCTION ====

    window.editPost = function(postId, content) {
    console.log('Edit post:', postId, content);
    alert('Edit functionality coming soon!');
    };

          
          if (!res.ok) throw new Error('Save failed');
 
          const user = await res.json();
          currentUser = user;
          localStorage.setItem('currentUser', JSON.stringify(user));
          
          displayBio.textContent = user.bio || 'Your bio goes here. Share a little about yourself!';
          displayMajor.textContent = user.major ? `Major: ${user.major}` : 'Major: -';
          displayMinor.textContent = user.minor ? `Minor: ${user.minor}` : 'Minor: -';
          displayYear.textContent = user.graduationYear ? `Graduation: ${user.graduationYear}` : 'Graduation: -';
 
          // Exit edit mode
          displayMajor.style.display = 'block';
          displayMinor.style.display = 'block';
          displayYear.style.display = 'block';
          displayBio.style.display = 'block';
          
          majorInput.style.display = 'none';
          minorInput.style.display = 'none';
          graduationYearSelect.style.display = 'none';
          bioInput.style.display = 'none';
          
          saveBtn.style.display = 'none';
          editBtn.style.display = 'block';
 
          alert('Profile updated successfully!');
          console.log("[profile] saved profile for", user.username);
        } catch (e) {
          console.error("[profile] save failed", e);
          alert('Could not save profile. Is the backend running?');
        }
      });
    // ==== LIKE/DISLIKE FUNCTIONS ====

    // Toggle Like
    window.toggleLike = async function(postId) {
    if (!currentUser) {
    alert('Please login to like posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/like?userId=${currentUser.id}`, {
    method: 'POST'
    });

    if (!response.ok) throw new Error('Failed to toggle like');

    const data = await response.json();
    updatePostStats(postId, data);
    } catch (error) {
    console.error('Error toggling like:', error);
    }
    };

    // Toggle Dislike
    window.toggleDislike = async function(postId) {
    if (!currentUser) {
    alert('Please login to dislike posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/dislike?userId=${currentUser.id}`, {
    method: 'POST'
    });

    if (!response.ok) throw new Error('Failed to toggle dislike');

    const data = await response.json();
    updatePostStats(postId, data);
    } catch (error) {
    console.error('Error toggling dislike:', error);
    }
    };

    // Update post statistics in UI
    function updatePostStats(postId, data) {
    const postCard = document.querySelector(`[data-post-id="${postId}"]`);
    if (!postCard) return;

    // Update like button and count
    const likeBtn = postCard.querySelector('.like-btn');
    const likeCount = postCard.querySelector('.like-count');
    if (likeBtn && likeCount) {
    likeCount.textContent = data.likeCount;
    if (data.userLiked) {
    likeBtn.classList.remove('btn-outline-success');
    likeBtn.classList.add('btn-success');
    } else {
    likeBtn.classList.remove('btn-success');
    likeBtn.classList.add('btn-outline-success');
    }
    }

    // Update dislike button and count
    const dislikeBtn = postCard.querySelector('.dislike-btn');
    const dislikeCount = postCard.querySelector('.dislike-count');
    if (dislikeBtn && dislikeCount) {
    dislikeCount.textContent = data.dislikeCount;
    if (data.userDisliked) {
    dislikeBtn.classList.remove('btn-outline-danger');
    dislikeBtn.classList.add('btn-danger');
    } else {
    dislikeBtn.classList.remove('btn-danger');
    dislikeBtn.classList.add('btn-outline-danger');
    }
    }
    }

    // ==== COMMENT FUNCTIONS ====

    // Toggle comments visibility
    window.toggleComments = async function(postId) {
    const commentsSection = document.getElementById(`comments-${postId}`);
    if (!commentsSection) return;

    if (commentsSection.style.display === 'none') {
    commentsSection.style.display = 'block';
    await loadComments(postId);
    } else {
    commentsSection.style.display = 'none';
    }
    };

    // Load comments for a post
    async function loadComments(postId) {
    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/comments`);
    if (!response.ok) throw new Error('Failed to load comments');

    const comments = await response.json();
    const commentList = document.getElementById(`comment-list-${postId}`);

    if (comments.length === 0) {
    commentList.innerHTML = '<p class="text-muted">No comments yet</p>';
    return;
    }

    commentList.innerHTML = comments.map(comment => {
    const commentDate = new Date(comment.createdAt);
    const timeAgo = getTimeAgo(commentDate);
    const profilePic = comment.userProfilePicture || 'images/default profile picture.jpg';
    const isOwnComment = currentUser && currentUser.id === comment.userId;
    const isAdmin = currentUser && currentUser.role === 'ADMIN';
    const canDeleteComment = isOwnComment || isAdmin;

    return `
    <div class="comment mb-3" data-comment-id="${comment.id}">
    <div class="d-flex align-items-start">
    <img src="${profilePic}" alt="User" width="40" height="40" 
    class="rounded-circle me-2" onerror="this.src='images/default profile picture.jpg'">
    <div class="flex-grow-1">
    <div>
    <strong>${comment.username}</strong>
    <span class="text-muted ms-2" style="font-size: 0.85rem;">${timeAgo}</span>
    </div>
    <p class="mb-1">${comment.commentText}</p>
    ${canDeleteComment ? `
    <button class="btn btn-sm btn-outline-danger" onclick="deleteComment(${comment.id}, ${postId})">
    Delete${isAdmin && !isOwnComment ? ' (Admin)' : ''}
    </button>
    ` : ''}
    </div>
    </div>
    </div>
    `;
    }).join('');
    } catch (error) {
    console.error('Error loading comments:', error);
    }
    }

    // Add a new comment
    window.addComment = async function(postId) {
    if (!currentUser) {
    alert('Please login to comment');
    return;
    }

    const input = document.getElementById(`comment-input-${postId}`);
    const commentText = input.value.trim();

    if (!commentText) {
    alert('Comment cannot be empty');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/comments?userId=${currentUser.id}`, {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json'
    },
    body: JSON.stringify({ commentText })
    });

    if (!response.ok) throw new Error('Failed to add comment');

    input.value = '';
    await loadComments(postId);

    // Update comment count
    const commentCount = document.querySelector(`[data-post-id="${postId}"] .comment-count`);
    if (commentCount) {
    commentCount.textContent = parseInt(commentCount.textContent) + 1;
    }
    } catch (error) {
    console.error('Error adding comment:', error);
    }
    };

    // Delete a comment
    window.deleteComment = async function(commentId, postId) {
    if (!currentUser) return;

    if (!confirm('Are you sure you want to delete this comment?')) return;

    try {
    const response = await fetch(`${API_BASE}/api/posts/comments/${commentId}?userId=${currentUser.id}`, {
    method: 'DELETE'
    });

    if (!response.ok) throw new Error('Failed to delete comment');

    await loadComments(postId);

    // Update comment count
    const commentCount = document.querySelector(`[data-post-id="${postId}"] .comment-count`);
    if (commentCount) {
    commentCount.textContent = Math.max(0, parseInt(commentCount.textContent) - 1);
    }
    } catch (error) {
    console.error('Error deleting comment:', error);
    }
    };

    // ==== FLAG POST FUNCTION ====

    window.flagPost = async function(postId, reason) {
    if (!currentUser) {
    alert('Please login to flag posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/flags?postId=${postId}&userId=${currentUser.id}&reason=${encodeURIComponent(reason)}`, {
    method: 'POST',
    credentials: 'include'
    });

    const data = await response.json();

    if (!response.ok) {
    throw new Error(data.message || 'Failed to flag post');
    }

    alert(`Post flagged as ${reason} successfully!`);
    loadUserPosts();

    } catch (error) {
    console.error('Error:', error);
    alert('Error: ' + error.message);
    }
    };

    // ==== EDIT POST FUNCTION ====

    window.editPost = function(postId, content) {
    console.log('Edit post:', postId, content);
    alert('Edit functionality coming soon!');
    };


      // Create Post
      postBtn.addEventListener('click', async () => {
        if (!currentUser) {
          alert('Please login to create posts');
          return;
        }
        
        const content = postContent.value.trim();
        const imageFile = postImage ? postImage.files[0] : null;

        if (!content && !imageFile) {
          alert('Please write something or select an image');
          return;
        }

        const formData = new FormData();
        formData.append('userId', currentUser.id);
        if (content) formData.append('content', content);
        if (imageFile) formData.append('image', imageFile);

        try {
          const res = await fetch(`${API_BASE}/api/posts`, {
            method: 'POST',
            body: formData
          });
    // ==== LIKE/DISLIKE FUNCTIONS ====

    // Toggle Like
    window.toggleLike = async function(postId) {
    if (!currentUser) {
    alert('Please login to like posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/like?userId=${currentUser.id}`, {
    method: 'POST'
    });

    if (!response.ok) throw new Error('Failed to toggle like');

    const data = await response.json();
    updatePostStats(postId, data);
    } catch (error) {
    console.error('Error toggling like:', error);
    }
    };

    // Toggle Dislike
    window.toggleDislike = async function(postId) {
    if (!currentUser) {
    alert('Please login to dislike posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/dislike?userId=${currentUser.id}`, {
    method: 'POST'
    });

    if (!response.ok) throw new Error('Failed to toggle dislike');

    const data = await response.json();
    updatePostStats(postId, data);
    } catch (error) {
    console.error('Error toggling dislike:', error);
    }
    };

    // Update post statistics in UI
    function updatePostStats(postId, data) {
    const postCard = document.querySelector(`[data-post-id="${postId}"]`);
    if (!postCard) return;

    // Update like button and count
    const likeBtn = postCard.querySelector('.like-btn');
    const likeCount = postCard.querySelector('.like-count');
    if (likeBtn && likeCount) {
    likeCount.textContent = data.likeCount;
    if (data.userLiked) {
    likeBtn.classList.remove('btn-outline-success');
    likeBtn.classList.add('btn-success');
    } else {
    likeBtn.classList.remove('btn-success');
    likeBtn.classList.add('btn-outline-success');
    }
    }

    // Update dislike button and count
    const dislikeBtn = postCard.querySelector('.dislike-btn');
    const dislikeCount = postCard.querySelector('.dislike-count');
    if (dislikeBtn && dislikeCount) {
    dislikeCount.textContent = data.dislikeCount;
    if (data.userDisliked) {
    dislikeBtn.classList.remove('btn-outline-danger');
    dislikeBtn.classList.add('btn-danger');
    } else {
    dislikeBtn.classList.remove('btn-danger');
    dislikeBtn.classList.add('btn-outline-danger');
    }
    }
    }

    // ==== COMMENT FUNCTIONS ====

    // Toggle comments visibility
    window.toggleComments = async function(postId) {
    const commentsSection = document.getElementById(`comments-${postId}`);
    if (!commentsSection) return;

    if (commentsSection.style.display === 'none') {
    commentsSection.style.display = 'block';
    await loadComments(postId);
    } else {
    commentsSection.style.display = 'none';
    }
    };

    // Load comments for a post
    async function loadComments(postId) {
    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/comments`);
    if (!response.ok) throw new Error('Failed to load comments');

    const comments = await response.json();
    const commentList = document.getElementById(`comment-list-${postId}`);

    if (comments.length === 0) {
    commentList.innerHTML = '<p class="text-muted">No comments yet</p>';
    return;
    }

    commentList.innerHTML = comments.map(comment => {
    const commentDate = new Date(comment.createdAt);
    const timeAgo = getTimeAgo(commentDate);
    const profilePic = comment.userProfilePicture || 'images/default profile picture.jpg';
    const isOwnComment = currentUser && currentUser.id === comment.userId;
    const isAdmin = currentUser && currentUser.role === 'ADMIN';
    const canDeleteComment = isOwnComment || isAdmin;

    return `
    <div class="comment mb-3" data-comment-id="${comment.id}">
    <div class="d-flex align-items-start">
    <img src="${profilePic}" alt="User" width="40" height="40" 
    class="rounded-circle me-2" onerror="this.src='images/default profile picture.jpg'">
    <div class="flex-grow-1">
    <div>
    <strong>${comment.username}</strong>
    <span class="text-muted ms-2" style="font-size: 0.85rem;">${timeAgo}</span>
    </div>
    <p class="mb-1">${comment.commentText}</p>
    ${canDeleteComment ? `
    <button class="btn btn-sm btn-outline-danger" onclick="deleteComment(${comment.id}, ${postId})">
    Delete${isAdmin && !isOwnComment ? ' (Admin)' : ''}
    </button>
    ` : ''}
    </div>
    </div>
    </div>
    `;
    }).join('');
    } catch (error) {
    console.error('Error loading comments:', error);
    }
    }

    // Add a new comment
    window.addComment = async function(postId) {
    if (!currentUser) {
    alert('Please login to comment');
    return;
    }

    const input = document.getElementById(`comment-input-${postId}`);
    const commentText = input.value.trim();

    if (!commentText) {
    alert('Comment cannot be empty');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/comments?userId=${currentUser.id}`, {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json'
    },
    body: JSON.stringify({ commentText })
    });

    if (!response.ok) throw new Error('Failed to add comment');

    input.value = '';
    await loadComments(postId);

    // Update comment count
    const commentCount = document.querySelector(`[data-post-id="${postId}"] .comment-count`);
    if (commentCount) {
    commentCount.textContent = parseInt(commentCount.textContent) + 1;
    }
    } catch (error) {
    console.error('Error adding comment:', error);
    }
    };

    // Delete a comment
    window.deleteComment = async function(commentId, postId) {
    if (!currentUser) return;

    if (!confirm('Are you sure you want to delete this comment?')) return;

    try {
    const response = await fetch(`${API_BASE}/api/posts/comments/${commentId}?userId=${currentUser.id}`, {
    method: 'DELETE'
    });

    if (!response.ok) throw new Error('Failed to delete comment');

    await loadComments(postId);

    // Update comment count
    const commentCount = document.querySelector(`[data-post-id="${postId}"] .comment-count`);
    if (commentCount) {
    commentCount.textContent = Math.max(0, parseInt(commentCount.textContent) - 1);
    }
    } catch (error) {
    console.error('Error deleting comment:', error);
    }
    };

    // ==== FLAG POST FUNCTION ====

    window.flagPost = async function(postId, reason) {
    if (!currentUser) {
    alert('Please login to flag posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/flags?postId=${postId}&userId=${currentUser.id}&reason=${encodeURIComponent(reason)}`, {
    method: 'POST',
    credentials: 'include'
    });

    const data = await response.json();

    if (!response.ok) {
    throw new Error(data.message || 'Failed to flag post');
    }

    alert(`Post flagged as ${reason} successfully!`);
    loadUserPosts();

    } catch (error) {
    console.error('Error:', error);
    alert('Error: ' + error.message);
    }
    };

    // ==== EDIT POST FUNCTION ====

    window.editPost = function(postId, content) {
    console.log('Edit post:', postId, content);
    alert('Edit functionality coming soon!');
    };


          if (!res.ok) throw new Error('Post failed');

          alert('Post created successfully!');
          postContent.value = '';
          if (postImage) postImage.value = '';
          loadUserPosts();
        } catch (error) {
          console.error('Error creating post:', error);
          alert('Failed to create post. Is the backend running?');
        }
      });
    // ==== LIKE/DISLIKE FUNCTIONS ====

    // Toggle Like
    window.toggleLike = async function(postId) {
    if (!currentUser) {
    alert('Please login to like posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/like?userId=${currentUser.id}`, {
    method: 'POST'
    });

    if (!response.ok) throw new Error('Failed to toggle like');

    const data = await response.json();
    updatePostStats(postId, data);
    } catch (error) {
    console.error('Error toggling like:', error);
    }
    };

    // Toggle Dislike
    window.toggleDislike = async function(postId) {
    if (!currentUser) {
    alert('Please login to dislike posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/dislike?userId=${currentUser.id}`, {
    method: 'POST'
    });

    if (!response.ok) throw new Error('Failed to toggle dislike');

    const data = await response.json();
    updatePostStats(postId, data);
    } catch (error) {
    console.error('Error toggling dislike:', error);
    }
    };

    // Update post statistics in UI
    function updatePostStats(postId, data) {
    const postCard = document.querySelector(`[data-post-id="${postId}"]`);
    if (!postCard) return;

    // Update like button and count
    const likeBtn = postCard.querySelector('.like-btn');
    const likeCount = postCard.querySelector('.like-count');
    if (likeBtn && likeCount) {
    likeCount.textContent = data.likeCount;
    if (data.userLiked) {
    likeBtn.classList.remove('btn-outline-success');
    likeBtn.classList.add('btn-success');
    } else {
    likeBtn.classList.remove('btn-success');
    likeBtn.classList.add('btn-outline-success');
    }
    }

    // Update dislike button and count
    const dislikeBtn = postCard.querySelector('.dislike-btn');
    const dislikeCount = postCard.querySelector('.dislike-count');
    if (dislikeBtn && dislikeCount) {
    dislikeCount.textContent = data.dislikeCount;
    if (data.userDisliked) {
    dislikeBtn.classList.remove('btn-outline-danger');
    dislikeBtn.classList.add('btn-danger');
    } else {
    dislikeBtn.classList.remove('btn-danger');
    dislikeBtn.classList.add('btn-outline-danger');
    }
    }
    }

    // ==== COMMENT FUNCTIONS ====

    // Toggle comments visibility
    window.toggleComments = async function(postId) {
    const commentsSection = document.getElementById(`comments-${postId}`);
    if (!commentsSection) return;

    if (commentsSection.style.display === 'none') {
    commentsSection.style.display = 'block';
    await loadComments(postId);
    } else {
    commentsSection.style.display = 'none';
    }
    };

    // Load comments for a post
    async function loadComments(postId) {
    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/comments`);
    if (!response.ok) throw new Error('Failed to load comments');

    const comments = await response.json();
    const commentList = document.getElementById(`comment-list-${postId}`);

    if (comments.length === 0) {
    commentList.innerHTML = '<p class="text-muted">No comments yet</p>';
    return;
    }

    commentList.innerHTML = comments.map(comment => {
    const commentDate = new Date(comment.createdAt);
    const timeAgo = getTimeAgo(commentDate);
    const profilePic = comment.userProfilePicture || 'images/default profile picture.jpg';
    const isOwnComment = currentUser && currentUser.id === comment.userId;
    const isAdmin = currentUser && currentUser.role === 'ADMIN';
    const canDeleteComment = isOwnComment || isAdmin;

    return `
    <div class="comment mb-3" data-comment-id="${comment.id}">
    <div class="d-flex align-items-start">
    <img src="${profilePic}" alt="User" width="40" height="40" 
    class="rounded-circle me-2" onerror="this.src='images/default profile picture.jpg'">
    <div class="flex-grow-1">
    <div>
    <strong>${comment.username}</strong>
    <span class="text-muted ms-2" style="font-size: 0.85rem;">${timeAgo}</span>
    </div>
    <p class="mb-1">${comment.commentText}</p>
    ${canDeleteComment ? `
    <button class="btn btn-sm btn-outline-danger" onclick="deleteComment(${comment.id}, ${postId})">
    Delete${isAdmin && !isOwnComment ? ' (Admin)' : ''}
    </button>
    ` : ''}
    </div>
    </div>
    </div>
    `;
    }).join('');
    } catch (error) {
    console.error('Error loading comments:', error);
    }
    }

    // Add a new comment
    window.addComment = async function(postId) {
    if (!currentUser) {
    alert('Please login to comment');
    return;
    }

    const input = document.getElementById(`comment-input-${postId}`);
    const commentText = input.value.trim();

    if (!commentText) {
    alert('Comment cannot be empty');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/comments?userId=${currentUser.id}`, {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json'
    },
    body: JSON.stringify({ commentText })
    });

    if (!response.ok) throw new Error('Failed to add comment');

    input.value = '';
    await loadComments(postId);

    // Update comment count
    const commentCount = document.querySelector(`[data-post-id="${postId}"] .comment-count`);
    if (commentCount) {
    commentCount.textContent = parseInt(commentCount.textContent) + 1;
    }
    } catch (error) {
    console.error('Error adding comment:', error);
    }
    };

    // Delete a comment
    window.deleteComment = async function(commentId, postId) {
    if (!currentUser) return;

    if (!confirm('Are you sure you want to delete this comment?')) return;

    try {
    const response = await fetch(`${API_BASE}/api/posts/comments/${commentId}?userId=${currentUser.id}`, {
    method: 'DELETE'
    });

    if (!response.ok) throw new Error('Failed to delete comment');

    await loadComments(postId);

    // Update comment count
    const commentCount = document.querySelector(`[data-post-id="${postId}"] .comment-count`);
    if (commentCount) {
    commentCount.textContent = Math.max(0, parseInt(commentCount.textContent) - 1);
    }
    } catch (error) {
    console.error('Error deleting comment:', error);
    }
    };

    // ==== FLAG POST FUNCTION ====

    window.flagPost = async function(postId, reason) {
    if (!currentUser) {
    alert('Please login to flag posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/flags?postId=${postId}&userId=${currentUser.id}&reason=${encodeURIComponent(reason)}`, {
    method: 'POST',
    credentials: 'include'
    });

    const data = await response.json();

    if (!response.ok) {
    throw new Error(data.message || 'Failed to flag post');
    }

    alert(`Post flagged as ${reason} successfully!`);
    loadUserPosts();

    } catch (error) {
    console.error('Error:', error);
    alert('Error: ' + error.message);
    }
    };

    // ==== EDIT POST FUNCTION ====

    window.editPost = function(postId, content) {
    console.log('Edit post:', postId, content);
    alert('Edit functionality coming soon!');
    };

 
      // LOGOUT
      logoutLink.addEventListener('click', async (e) => {
        e.preventDefault();
        console.log("[profile] logout clicked");
        try { 
          await fetch(`${API_BASE}/api/auth/logout`, { method: 'POST' }); 
        } catch (_) {}
        localStorage.removeItem('currentUser');
        localStorage.removeItem('username');
        window.location.href = 'login.html';
      });
    // ==== LIKE/DISLIKE FUNCTIONS ====

    // Toggle Like
    window.toggleLike = async function(postId) {
    if (!currentUser) {
    alert('Please login to like posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/like?userId=${currentUser.id}`, {
    method: 'POST'
    });

    if (!response.ok) throw new Error('Failed to toggle like');

    const data = await response.json();
    updatePostStats(postId, data);
    } catch (error) {
    console.error('Error toggling like:', error);
    }
    };

    // Toggle Dislike
    window.toggleDislike = async function(postId) {
    if (!currentUser) {
    alert('Please login to dislike posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/dislike?userId=${currentUser.id}`, {
    method: 'POST'
    });

    if (!response.ok) throw new Error('Failed to toggle dislike');

    const data = await response.json();
    updatePostStats(postId, data);
    } catch (error) {
    console.error('Error toggling dislike:', error);
    }
    };

    // Update post statistics in UI
    function updatePostStats(postId, data) {
    const postCard = document.querySelector(`[data-post-id="${postId}"]`);
    if (!postCard) return;

    // Update like button and count
    const likeBtn = postCard.querySelector('.like-btn');
    const likeCount = postCard.querySelector('.like-count');
    if (likeBtn && likeCount) {
    likeCount.textContent = data.likeCount;
    if (data.userLiked) {
    likeBtn.classList.remove('btn-outline-success');
    likeBtn.classList.add('btn-success');
    } else {
    likeBtn.classList.remove('btn-success');
    likeBtn.classList.add('btn-outline-success');
    }
    }

    // Update dislike button and count
    const dislikeBtn = postCard.querySelector('.dislike-btn');
    const dislikeCount = postCard.querySelector('.dislike-count');
    if (dislikeBtn && dislikeCount) {
    dislikeCount.textContent = data.dislikeCount;
    if (data.userDisliked) {
    dislikeBtn.classList.remove('btn-outline-danger');
    dislikeBtn.classList.add('btn-danger');
    } else {
    dislikeBtn.classList.remove('btn-danger');
    dislikeBtn.classList.add('btn-outline-danger');
    }
    }
    }

    // ==== COMMENT FUNCTIONS ====

    // Toggle comments visibility
    window.toggleComments = async function(postId) {
    const commentsSection = document.getElementById(`comments-${postId}`);
    if (!commentsSection) return;

    if (commentsSection.style.display === 'none') {
    commentsSection.style.display = 'block';
    await loadComments(postId);
    } else {
    commentsSection.style.display = 'none';
    }
    };

    // Load comments for a post
    async function loadComments(postId) {
    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/comments`);
    if (!response.ok) throw new Error('Failed to load comments');

    const comments = await response.json();
    const commentList = document.getElementById(`comment-list-${postId}`);

    if (comments.length === 0) {
    commentList.innerHTML = '<p class="text-muted">No comments yet</p>';
    return;
    }

    commentList.innerHTML = comments.map(comment => {
    const commentDate = new Date(comment.createdAt);
    const timeAgo = getTimeAgo(commentDate);
    const profilePic = comment.userProfilePicture || 'images/default profile picture.jpg';
    const isOwnComment = currentUser && currentUser.id === comment.userId;
    const isAdmin = currentUser && currentUser.role === 'ADMIN';
    const canDeleteComment = isOwnComment || isAdmin;

    return `
    <div class="comment mb-3" data-comment-id="${comment.id}">
    <div class="d-flex align-items-start">
    <img src="${profilePic}" alt="User" width="40" height="40" 
    class="rounded-circle me-2" onerror="this.src='images/default profile picture.jpg'">
    <div class="flex-grow-1">
    <div>
    <strong>${comment.username}</strong>
    <span class="text-muted ms-2" style="font-size: 0.85rem;">${timeAgo}</span>
    </div>
    <p class="mb-1">${comment.commentText}</p>
    ${canDeleteComment ? `
    <button class="btn btn-sm btn-outline-danger" onclick="deleteComment(${comment.id}, ${postId})">
    Delete${isAdmin && !isOwnComment ? ' (Admin)' : ''}
    </button>
    ` : ''}
    </div>
    </div>
    </div>
    `;
    }).join('');
    } catch (error) {
    console.error('Error loading comments:', error);
    }
    }

    // Add a new comment
    window.addComment = async function(postId) {
    if (!currentUser) {
    alert('Please login to comment');
    return;
    }

    const input = document.getElementById(`comment-input-${postId}`);
    const commentText = input.value.trim();

    if (!commentText) {
    alert('Comment cannot be empty');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/comments?userId=${currentUser.id}`, {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json'
    },
    body: JSON.stringify({ commentText })
    });

    if (!response.ok) throw new Error('Failed to add comment');

    input.value = '';
    await loadComments(postId);

    // Update comment count
    const commentCount = document.querySelector(`[data-post-id="${postId}"] .comment-count`);
    if (commentCount) {
    commentCount.textContent = parseInt(commentCount.textContent) + 1;
    }
    } catch (error) {
    console.error('Error adding comment:', error);
    }
    };

    // Delete a comment
    window.deleteComment = async function(commentId, postId) {
    if (!currentUser) return;

    if (!confirm('Are you sure you want to delete this comment?')) return;

    try {
    const response = await fetch(`${API_BASE}/api/posts/comments/${commentId}?userId=${currentUser.id}`, {
    method: 'DELETE'
    });

    if (!response.ok) throw new Error('Failed to delete comment');

    await loadComments(postId);

    // Update comment count
    const commentCount = document.querySelector(`[data-post-id="${postId}"] .comment-count`);
    if (commentCount) {
    commentCount.textContent = Math.max(0, parseInt(commentCount.textContent) - 1);
    }
    } catch (error) {
    console.error('Error deleting comment:', error);
    }
    };

    // ==== FLAG POST FUNCTION ====

    window.flagPost = async function(postId, reason) {
    if (!currentUser) {
    alert('Please login to flag posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/flags?postId=${postId}&userId=${currentUser.id}&reason=${encodeURIComponent(reason)}`, {
    method: 'POST',
    credentials: 'include'
    });

    const data = await response.json();

    if (!response.ok) {
    throw new Error(data.message || 'Failed to flag post');
    }

    alert(`Post flagged as ${reason} successfully!`);
    loadUserPosts();

    } catch (error) {
    console.error('Error:', error);
    alert('Error: ' + error.message);
    }
    };

    // ==== EDIT POST FUNCTION ====

    window.editPost = function(postId, content) {
    console.log('Edit post:', postId, content);
    alert('Edit functionality coming soon!');
    };


      // ===== SEARCH FUNCTIONALITY =====
      let searchTimeout;
      const searchInput = document.getElementById('searchInput');
      const searchDropdown = document.getElementById('searchDropdown');

      // Live search on input
      searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();

        if (query.length < 2) {
          searchDropdown.classList.remove('show');
          return;
        }

        searchTimeout = setTimeout(() => {
          performLiveSearch(query);
        }, 300); // Debounce 300ms
      });
    // ==== LIKE/DISLIKE FUNCTIONS ====

    // Toggle Like
    window.toggleLike = async function(postId) {
    if (!currentUser) {
    alert('Please login to like posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/like?userId=${currentUser.id}`, {
    method: 'POST'
    });

    if (!response.ok) throw new Error('Failed to toggle like');

    const data = await response.json();
    updatePostStats(postId, data);
    } catch (error) {
    console.error('Error toggling like:', error);
    }
    };

    // Toggle Dislike
    window.toggleDislike = async function(postId) {
    if (!currentUser) {
    alert('Please login to dislike posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/dislike?userId=${currentUser.id}`, {
    method: 'POST'
    });

    if (!response.ok) throw new Error('Failed to toggle dislike');

    const data = await response.json();
    updatePostStats(postId, data);
    } catch (error) {
    console.error('Error toggling dislike:', error);
    }
    };

    // Update post statistics in UI
    function updatePostStats(postId, data) {
    const postCard = document.querySelector(`[data-post-id="${postId}"]`);
    if (!postCard) return;

    // Update like button and count
    const likeBtn = postCard.querySelector('.like-btn');
    const likeCount = postCard.querySelector('.like-count');
    if (likeBtn && likeCount) {
    likeCount.textContent = data.likeCount;
    if (data.userLiked) {
    likeBtn.classList.remove('btn-outline-success');
    likeBtn.classList.add('btn-success');
    } else {
    likeBtn.classList.remove('btn-success');
    likeBtn.classList.add('btn-outline-success');
    }
    }

    // Update dislike button and count
    const dislikeBtn = postCard.querySelector('.dislike-btn');
    const dislikeCount = postCard.querySelector('.dislike-count');
    if (dislikeBtn && dislikeCount) {
    dislikeCount.textContent = data.dislikeCount;
    if (data.userDisliked) {
    dislikeBtn.classList.remove('btn-outline-danger');
    dislikeBtn.classList.add('btn-danger');
    } else {
    dislikeBtn.classList.remove('btn-danger');
    dislikeBtn.classList.add('btn-outline-danger');
    }
    }
    }

    // ==== COMMENT FUNCTIONS ====

    // Toggle comments visibility
    window.toggleComments = async function(postId) {
    const commentsSection = document.getElementById(`comments-${postId}`);
    if (!commentsSection) return;

    if (commentsSection.style.display === 'none') {
    commentsSection.style.display = 'block';
    await loadComments(postId);
    } else {
    commentsSection.style.display = 'none';
    }
    };

    // Load comments for a post
    async function loadComments(postId) {
    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/comments`);
    if (!response.ok) throw new Error('Failed to load comments');

    const comments = await response.json();
    const commentList = document.getElementById(`comment-list-${postId}`);

    if (comments.length === 0) {
    commentList.innerHTML = '<p class="text-muted">No comments yet</p>';
    return;
    }

    commentList.innerHTML = comments.map(comment => {
    const commentDate = new Date(comment.createdAt);
    const timeAgo = getTimeAgo(commentDate);
    const profilePic = comment.userProfilePicture || 'images/default profile picture.jpg';
    const isOwnComment = currentUser && currentUser.id === comment.userId;
    const isAdmin = currentUser && currentUser.role === 'ADMIN';
    const canDeleteComment = isOwnComment || isAdmin;

    return `
    <div class="comment mb-3" data-comment-id="${comment.id}">
    <div class="d-flex align-items-start">
    <img src="${profilePic}" alt="User" width="40" height="40" 
    class="rounded-circle me-2" onerror="this.src='images/default profile picture.jpg'">
    <div class="flex-grow-1">
    <div>
    <strong>${comment.username}</strong>
    <span class="text-muted ms-2" style="font-size: 0.85rem;">${timeAgo}</span>
    </div>
    <p class="mb-1">${comment.commentText}</p>
    ${canDeleteComment ? `
    <button class="btn btn-sm btn-outline-danger" onclick="deleteComment(${comment.id}, ${postId})">
    Delete${isAdmin && !isOwnComment ? ' (Admin)' : ''}
    </button>
    ` : ''}
    </div>
    </div>
    </div>
    `;
    }).join('');
    } catch (error) {
    console.error('Error loading comments:', error);
    }
    }

    // Add a new comment
    window.addComment = async function(postId) {
    if (!currentUser) {
    alert('Please login to comment');
    return;
    }

    const input = document.getElementById(`comment-input-${postId}`);
    const commentText = input.value.trim();

    if (!commentText) {
    alert('Comment cannot be empty');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/comments?userId=${currentUser.id}`, {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json'
    },
    body: JSON.stringify({ commentText })
    });

    if (!response.ok) throw new Error('Failed to add comment');

    input.value = '';
    await loadComments(postId);

    // Update comment count
    const commentCount = document.querySelector(`[data-post-id="${postId}"] .comment-count`);
    if (commentCount) {
    commentCount.textContent = parseInt(commentCount.textContent) + 1;
    }
    } catch (error) {
    console.error('Error adding comment:', error);
    }
    };

    // Delete a comment
    window.deleteComment = async function(commentId, postId) {
    if (!currentUser) return;

    if (!confirm('Are you sure you want to delete this comment?')) return;

    try {
    const response = await fetch(`${API_BASE}/api/posts/comments/${commentId}?userId=${currentUser.id}`, {
    method: 'DELETE'
    });

    if (!response.ok) throw new Error('Failed to delete comment');

    await loadComments(postId);

    // Update comment count
    const commentCount = document.querySelector(`[data-post-id="${postId}"] .comment-count`);
    if (commentCount) {
    commentCount.textContent = Math.max(0, parseInt(commentCount.textContent) - 1);
    }
    } catch (error) {
    console.error('Error deleting comment:', error);
    }
    };

    // ==== FLAG POST FUNCTION ====

    window.flagPost = async function(postId, reason) {
    if (!currentUser) {
    alert('Please login to flag posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/flags?postId=${postId}&userId=${currentUser.id}&reason=${encodeURIComponent(reason)}`, {
    method: 'POST',
    credentials: 'include'
    });

    const data = await response.json();

    if (!response.ok) {
    throw new Error(data.message || 'Failed to flag post');
    }

    alert(`Post flagged as ${reason} successfully!`);
    loadUserPosts();

    } catch (error) {
    console.error('Error:', error);
    alert('Error: ' + error.message);
    }
    };

    // ==== EDIT POST FUNCTION ====

    window.editPost = function(postId, content) {
    console.log('Edit post:', postId, content);
    alert('Edit functionality coming soon!');
    };


      // Close dropdown when clicking outside
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.search-container')) {
          searchDropdown.classList.remove('show');
        }
      });
    // ==== LIKE/DISLIKE FUNCTIONS ====

    // Toggle Like
    window.toggleLike = async function(postId) {
    if (!currentUser) {
    alert('Please login to like posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/like?userId=${currentUser.id}`, {
    method: 'POST'
    });

    if (!response.ok) throw new Error('Failed to toggle like');

    const data = await response.json();
    updatePostStats(postId, data);
    } catch (error) {
    console.error('Error toggling like:', error);
    }
    };

    // Toggle Dislike
    window.toggleDislike = async function(postId) {
    if (!currentUser) {
    alert('Please login to dislike posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/dislike?userId=${currentUser.id}`, {
    method: 'POST'
    });

    if (!response.ok) throw new Error('Failed to toggle dislike');

    const data = await response.json();
    updatePostStats(postId, data);
    } catch (error) {
    console.error('Error toggling dislike:', error);
    }
    };

    // Update post statistics in UI
    function updatePostStats(postId, data) {
    const postCard = document.querySelector(`[data-post-id="${postId}"]`);
    if (!postCard) return;

    // Update like button and count
    const likeBtn = postCard.querySelector('.like-btn');
    const likeCount = postCard.querySelector('.like-count');
    if (likeBtn && likeCount) {
    likeCount.textContent = data.likeCount;
    if (data.userLiked) {
    likeBtn.classList.remove('btn-outline-success');
    likeBtn.classList.add('btn-success');
    } else {
    likeBtn.classList.remove('btn-success');
    likeBtn.classList.add('btn-outline-success');
    }
    }

    // Update dislike button and count
    const dislikeBtn = postCard.querySelector('.dislike-btn');
    const dislikeCount = postCard.querySelector('.dislike-count');
    if (dislikeBtn && dislikeCount) {
    dislikeCount.textContent = data.dislikeCount;
    if (data.userDisliked) {
    dislikeBtn.classList.remove('btn-outline-danger');
    dislikeBtn.classList.add('btn-danger');
    } else {
    dislikeBtn.classList.remove('btn-danger');
    dislikeBtn.classList.add('btn-outline-danger');
    }
    }
    }

    // ==== COMMENT FUNCTIONS ====

    // Toggle comments visibility
    window.toggleComments = async function(postId) {
    const commentsSection = document.getElementById(`comments-${postId}`);
    if (!commentsSection) return;

    if (commentsSection.style.display === 'none') {
    commentsSection.style.display = 'block';
    await loadComments(postId);
    } else {
    commentsSection.style.display = 'none';
    }
    };

    // Load comments for a post
    async function loadComments(postId) {
    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/comments`);
    if (!response.ok) throw new Error('Failed to load comments');

    const comments = await response.json();
    const commentList = document.getElementById(`comment-list-${postId}`);

    if (comments.length === 0) {
    commentList.innerHTML = '<p class="text-muted">No comments yet</p>';
    return;
    }

    commentList.innerHTML = comments.map(comment => {
    const commentDate = new Date(comment.createdAt);
    const timeAgo = getTimeAgo(commentDate);
    const profilePic = comment.userProfilePicture || 'images/default profile picture.jpg';
    const isOwnComment = currentUser && currentUser.id === comment.userId;
    const isAdmin = currentUser && currentUser.role === 'ADMIN';
    const canDeleteComment = isOwnComment || isAdmin;

    return `
    <div class="comment mb-3" data-comment-id="${comment.id}">
    <div class="d-flex align-items-start">
    <img src="${profilePic}" alt="User" width="40" height="40" 
    class="rounded-circle me-2" onerror="this.src='images/default profile picture.jpg'">
    <div class="flex-grow-1">
    <div>
    <strong>${comment.username}</strong>
    <span class="text-muted ms-2" style="font-size: 0.85rem;">${timeAgo}</span>
    </div>
    <p class="mb-1">${comment.commentText}</p>
    ${canDeleteComment ? `
    <button class="btn btn-sm btn-outline-danger" onclick="deleteComment(${comment.id}, ${postId})">
    Delete${isAdmin && !isOwnComment ? ' (Admin)' : ''}
    </button>
    ` : ''}
    </div>
    </div>
    </div>
    `;
    }).join('');
    } catch (error) {
    console.error('Error loading comments:', error);
    }
    }

    // Add a new comment
    window.addComment = async function(postId) {
    if (!currentUser) {
    alert('Please login to comment');
    return;
    }

    const input = document.getElementById(`comment-input-${postId}`);
    const commentText = input.value.trim();

    if (!commentText) {
    alert('Comment cannot be empty');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/comments?userId=${currentUser.id}`, {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json'
    },
    body: JSON.stringify({ commentText })
    });

    if (!response.ok) throw new Error('Failed to add comment');

    input.value = '';
    await loadComments(postId);

    // Update comment count
    const commentCount = document.querySelector(`[data-post-id="${postId}"] .comment-count`);
    if (commentCount) {
    commentCount.textContent = parseInt(commentCount.textContent) + 1;
    }
    } catch (error) {
    console.error('Error adding comment:', error);
    }
    };

    // Delete a comment
    window.deleteComment = async function(commentId, postId) {
    if (!currentUser) return;

    if (!confirm('Are you sure you want to delete this comment?')) return;

    try {
    const response = await fetch(`${API_BASE}/api/posts/comments/${commentId}?userId=${currentUser.id}`, {
    method: 'DELETE'
    });

    if (!response.ok) throw new Error('Failed to delete comment');

    await loadComments(postId);

    // Update comment count
    const commentCount = document.querySelector(`[data-post-id="${postId}"] .comment-count`);
    if (commentCount) {
    commentCount.textContent = Math.max(0, parseInt(commentCount.textContent) - 1);
    }
    } catch (error) {
    console.error('Error deleting comment:', error);
    }
    };

    // ==== FLAG POST FUNCTION ====

    window.flagPost = async function(postId, reason) {
    if (!currentUser) {
    alert('Please login to flag posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/flags?postId=${postId}&userId=${currentUser.id}&reason=${encodeURIComponent(reason)}`, {
    method: 'POST',
    credentials: 'include'
    });

    const data = await response.json();

    if (!response.ok) {
    throw new Error(data.message || 'Failed to flag post');
    }

    alert(`Post flagged as ${reason} successfully!`);
    loadUserPosts();

    } catch (error) {
    console.error('Error:', error);
    alert('Error: ' + error.message);
    }
    };

    // ==== EDIT POST FUNCTION ====

    window.editPost = function(postId, content) {
    console.log('Edit post:', postId, content);
    alert('Edit functionality coming soon!');
    };


      // Perform live search
      async function performLiveSearch(query) {
        try {
          const userId = currentUser ? currentUser.id : null;
          const url = `${API_BASE}/api/users/search?query=${encodeURIComponent(query)}${userId ? '&currentUserId=' + userId : ''}`;
          
          const response = await fetch(url);
          if (!response.ok) throw new Error('Search failed');

          const results = await response.json();
          displaySearchResults(results);
        } catch (error) {
          console.error('Search error:', error);
          searchDropdown.innerHTML = '<div class="search-no-results">Search error occurred</div>';
          searchDropdown.classList.add('show');
        }
      }

      // Display search results in dropdown
      function displaySearchResults(results) {
        if (results.length === 0) {
          searchDropdown.innerHTML = '<div class="search-no-results">No users found</div>';
        } else {
          searchDropdown.innerHTML = results.map(user => {
            const profilePic = user.profilePictureUrl || 'images/default profile picture.jpg';
            return `
              <div class="search-result-item" onclick="navigateToProfile('${user.username}')">
                <img src="${profilePic}" alt="${user.username}" onerror="this.src='images/default profile picture.jpg'">
                <span class="username">${user.username}</span>
              </div>
            `;
          }).join('');
        }
        searchDropdown.classList.add('show');
      }

      // Perform search (button click or enter key)
      window.performSearch = function() {
        const query = searchInput.value.trim();
        if (query.length >= 2) {
          performLiveSearch(query);
        }
      }

      // Handle Enter key in search input
      searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          performSearch();
        }
      });
    // ==== LIKE/DISLIKE FUNCTIONS ====

    // Toggle Like
    window.toggleLike = async function(postId) {
    if (!currentUser) {
    alert('Please login to like posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/like?userId=${currentUser.id}`, {
    method: 'POST'
    });

    if (!response.ok) throw new Error('Failed to toggle like');

    const data = await response.json();
    updatePostStats(postId, data);
    } catch (error) {
    console.error('Error toggling like:', error);
    }
    };

    // Toggle Dislike
    window.toggleDislike = async function(postId) {
    if (!currentUser) {
    alert('Please login to dislike posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/dislike?userId=${currentUser.id}`, {
    method: 'POST'
    });

    if (!response.ok) throw new Error('Failed to toggle dislike');

    const data = await response.json();
    updatePostStats(postId, data);
    } catch (error) {
    console.error('Error toggling dislike:', error);
    }
    };

    // Update post statistics in UI
    function updatePostStats(postId, data) {
    const postCard = document.querySelector(`[data-post-id="${postId}"]`);
    if (!postCard) return;

    // Update like button and count
    const likeBtn = postCard.querySelector('.like-btn');
    const likeCount = postCard.querySelector('.like-count');
    if (likeBtn && likeCount) {
    likeCount.textContent = data.likeCount;
    if (data.userLiked) {
    likeBtn.classList.remove('btn-outline-success');
    likeBtn.classList.add('btn-success');
    } else {
    likeBtn.classList.remove('btn-success');
    likeBtn.classList.add('btn-outline-success');
    }
    }

    // Update dislike button and count
    const dislikeBtn = postCard.querySelector('.dislike-btn');
    const dislikeCount = postCard.querySelector('.dislike-count');
    if (dislikeBtn && dislikeCount) {
    dislikeCount.textContent = data.dislikeCount;
    if (data.userDisliked) {
    dislikeBtn.classList.remove('btn-outline-danger');
    dislikeBtn.classList.add('btn-danger');
    } else {
    dislikeBtn.classList.remove('btn-danger');
    dislikeBtn.classList.add('btn-outline-danger');
    }
    }
    }

    // ==== COMMENT FUNCTIONS ====

    // Toggle comments visibility
    window.toggleComments = async function(postId) {
    const commentsSection = document.getElementById(`comments-${postId}`);
    if (!commentsSection) return;

    if (commentsSection.style.display === 'none') {
    commentsSection.style.display = 'block';
    await loadComments(postId);
    } else {
    commentsSection.style.display = 'none';
    }
    };

    // Load comments for a post
    async function loadComments(postId) {
    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/comments`);
    if (!response.ok) throw new Error('Failed to load comments');

    const comments = await response.json();
    const commentList = document.getElementById(`comment-list-${postId}`);

    if (comments.length === 0) {
    commentList.innerHTML = '<p class="text-muted">No comments yet</p>';
    return;
    }

    commentList.innerHTML = comments.map(comment => {
    const commentDate = new Date(comment.createdAt);
    const timeAgo = getTimeAgo(commentDate);
    const profilePic = comment.userProfilePicture || 'images/default profile picture.jpg';
    const isOwnComment = currentUser && currentUser.id === comment.userId;
    const isAdmin = currentUser && currentUser.role === 'ADMIN';
    const canDeleteComment = isOwnComment || isAdmin;

    return `
    <div class="comment mb-3" data-comment-id="${comment.id}">
    <div class="d-flex align-items-start">
    <img src="${profilePic}" alt="User" width="40" height="40" 
    class="rounded-circle me-2" onerror="this.src='images/default profile picture.jpg'">
    <div class="flex-grow-1">
    <div>
    <strong>${comment.username}</strong>
    <span class="text-muted ms-2" style="font-size: 0.85rem;">${timeAgo}</span>
    </div>
    <p class="mb-1">${comment.commentText}</p>
    ${canDeleteComment ? `
    <button class="btn btn-sm btn-outline-danger" onclick="deleteComment(${comment.id}, ${postId})">
    Delete${isAdmin && !isOwnComment ? ' (Admin)' : ''}
    </button>
    ` : ''}
    </div>
    </div>
    </div>
    `;
    }).join('');
    } catch (error) {
    console.error('Error loading comments:', error);
    }
    }

    // Add a new comment
    window.addComment = async function(postId) {
    if (!currentUser) {
    alert('Please login to comment');
    return;
    }

    const input = document.getElementById(`comment-input-${postId}`);
    const commentText = input.value.trim();

    if (!commentText) {
    alert('Comment cannot be empty');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/comments?userId=${currentUser.id}`, {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json'
    },
    body: JSON.stringify({ commentText })
    });

    if (!response.ok) throw new Error('Failed to add comment');

    input.value = '';
    await loadComments(postId);

    // Update comment count
    const commentCount = document.querySelector(`[data-post-id="${postId}"] .comment-count`);
    if (commentCount) {
    commentCount.textContent = parseInt(commentCount.textContent) + 1;
    }
    } catch (error) {
    console.error('Error adding comment:', error);
    }
    };

    // Delete a comment
    window.deleteComment = async function(commentId, postId) {
    if (!currentUser) return;

    if (!confirm('Are you sure you want to delete this comment?')) return;

    try {
    const response = await fetch(`${API_BASE}/api/posts/comments/${commentId}?userId=${currentUser.id}`, {
    method: 'DELETE'
    });

    if (!response.ok) throw new Error('Failed to delete comment');

    await loadComments(postId);

    // Update comment count
    const commentCount = document.querySelector(`[data-post-id="${postId}"] .comment-count`);
    if (commentCount) {
    commentCount.textContent = Math.max(0, parseInt(commentCount.textContent) - 1);
    }
    } catch (error) {
    console.error('Error deleting comment:', error);
    }
    };

    // ==== FLAG POST FUNCTION ====

    window.flagPost = async function(postId, reason) {
    if (!currentUser) {
    alert('Please login to flag posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/flags?postId=${postId}&userId=${currentUser.id}&reason=${encodeURIComponent(reason)}`, {
    method: 'POST',
    credentials: 'include'
    });

    const data = await response.json();

    if (!response.ok) {
    throw new Error(data.message || 'Failed to flag post');
    }

    alert(`Post flagged as ${reason} successfully!`);
    loadUserPosts();

    } catch (error) {
    console.error('Error:', error);
    alert('Error: ' + error.message);
    }
    };

    // ==== EDIT POST FUNCTION ====

    window.editPost = function(postId, content) {
    console.log('Edit post:', postId, content);
    alert('Edit functionality coming soon!');
    };


      // Navigate to user profile
      window.navigateToProfile = function(username) {
        window.location.href = `user-profile.html?username=${encodeURIComponent(username)}`;
      }
    });
    // ==== LIKE/DISLIKE FUNCTIONS ====

    // Toggle Like
    window.toggleLike = async function(postId) {
    if (!currentUser) {
    alert('Please login to like posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/like?userId=${currentUser.id}`, {
    method: 'POST'
    });

    if (!response.ok) throw new Error('Failed to toggle like');

    const data = await response.json();
    updatePostStats(postId, data);
    } catch (error) {
    console.error('Error toggling like:', error);
    }
    };

    // Toggle Dislike
    window.toggleDislike = async function(postId) {
    if (!currentUser) {
    alert('Please login to dislike posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/dislike?userId=${currentUser.id}`, {
    method: 'POST'
    });

    if (!response.ok) throw new Error('Failed to toggle dislike');

    const data = await response.json();
    updatePostStats(postId, data);
    } catch (error) {
    console.error('Error toggling dislike:', error);
    }
    };

    // Update post statistics in UI
    function updatePostStats(postId, data) {
    const postCard = document.querySelector(`[data-post-id="${postId}"]`);
    if (!postCard) return;

    // Update like button and count
    const likeBtn = postCard.querySelector('.like-btn');
    const likeCount = postCard.querySelector('.like-count');
    if (likeBtn && likeCount) {
    likeCount.textContent = data.likeCount;
    if (data.userLiked) {
    likeBtn.classList.remove('btn-outline-success');
    likeBtn.classList.add('btn-success');
    } else {
    likeBtn.classList.remove('btn-success');
    likeBtn.classList.add('btn-outline-success');
    }
    }

    // Update dislike button and count
    const dislikeBtn = postCard.querySelector('.dislike-btn');
    const dislikeCount = postCard.querySelector('.dislike-count');
    if (dislikeBtn && dislikeCount) {
    dislikeCount.textContent = data.dislikeCount;
    if (data.userDisliked) {
    dislikeBtn.classList.remove('btn-outline-danger');
    dislikeBtn.classList.add('btn-danger');
    } else {
    dislikeBtn.classList.remove('btn-danger');
    dislikeBtn.classList.add('btn-outline-danger');
    }
    }
    }

    // ==== COMMENT FUNCTIONS ====

    // Toggle comments visibility
    window.toggleComments = async function(postId) {
    const commentsSection = document.getElementById(`comments-${postId}`);
    if (!commentsSection) return;

    if (commentsSection.style.display === 'none') {
    commentsSection.style.display = 'block';
    await loadComments(postId);
    } else {
    commentsSection.style.display = 'none';
    }
    };

    // Load comments for a post
    async function loadComments(postId) {
    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/comments`);
    if (!response.ok) throw new Error('Failed to load comments');

    const comments = await response.json();
    const commentList = document.getElementById(`comment-list-${postId}`);

    if (comments.length === 0) {
    commentList.innerHTML = '<p class="text-muted">No comments yet</p>';
    return;
    }

    commentList.innerHTML = comments.map(comment => {
    const commentDate = new Date(comment.createdAt);
    const timeAgo = getTimeAgo(commentDate);
    const profilePic = comment.userProfilePicture || 'images/default profile picture.jpg';
    const isOwnComment = currentUser && currentUser.id === comment.userId;
    const isAdmin = currentUser && currentUser.role === 'ADMIN';
    const canDeleteComment = isOwnComment || isAdmin;

    return `
    <div class="comment mb-3" data-comment-id="${comment.id}">
    <div class="d-flex align-items-start">
    <img src="${profilePic}" alt="User" width="40" height="40" 
    class="rounded-circle me-2" onerror="this.src='images/default profile picture.jpg'">
    <div class="flex-grow-1">
    <div>
    <strong>${comment.username}</strong>
    <span class="text-muted ms-2" style="font-size: 0.85rem;">${timeAgo}</span>
    </div>
    <p class="mb-1">${comment.commentText}</p>
    ${canDeleteComment ? `
    <button class="btn btn-sm btn-outline-danger" onclick="deleteComment(${comment.id}, ${postId})">
    Delete${isAdmin && !isOwnComment ? ' (Admin)' : ''}
    </button>
    ` : ''}
    </div>
    </div>
    </div>
    `;
    }).join('');
    } catch (error) {
    console.error('Error loading comments:', error);
    }
    }

    // Add a new comment
    window.addComment = async function(postId) {
    if (!currentUser) {
    alert('Please login to comment');
    return;
    }

    const input = document.getElementById(`comment-input-${postId}`);
    const commentText = input.value.trim();

    if (!commentText) {
    alert('Comment cannot be empty');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/posts/${postId}/comments?userId=${currentUser.id}`, {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json'
    },
    body: JSON.stringify({ commentText })
    });

    if (!response.ok) throw new Error('Failed to add comment');

    input.value = '';
    await loadComments(postId);

    // Update comment count
    const commentCount = document.querySelector(`[data-post-id="${postId}"] .comment-count`);
    if (commentCount) {
    commentCount.textContent = parseInt(commentCount.textContent) + 1;
    }
    } catch (error) {
    console.error('Error adding comment:', error);
    }
    };

    // Delete a comment
    window.deleteComment = async function(commentId, postId) {
    if (!currentUser) return;

    if (!confirm('Are you sure you want to delete this comment?')) return;

    try {
    const response = await fetch(`${API_BASE}/api/posts/comments/${commentId}?userId=${currentUser.id}`, {
    method: 'DELETE'
    });

    if (!response.ok) throw new Error('Failed to delete comment');

    await loadComments(postId);

    // Update comment count
    const commentCount = document.querySelector(`[data-post-id="${postId}"] .comment-count`);
    if (commentCount) {
    commentCount.textContent = Math.max(0, parseInt(commentCount.textContent) - 1);
    }
    } catch (error) {
    console.error('Error deleting comment:', error);
    }
    };

    // ==== FLAG POST FUNCTION ====

    window.flagPost = async function(postId, reason) {
    if (!currentUser) {
    alert('Please login to flag posts');
    return;
    }

    try {
    const response = await fetch(`${API_BASE}/api/flags?postId=${postId}&userId=${currentUser.id}&reason=${encodeURIComponent(reason)}`, {
    method: 'POST',
    credentials: 'include'
    });

    const data = await response.json();

    if (!response.ok) {
    throw new Error(data.message || 'Failed to flag post');
    }

    alert(`Post flagged as ${reason} successfully!`);
    loadUserPosts();

    } catch (error) {
    console.error('Error:', error);
    alert('Error: ' + error.message);
    }
    };

    // ==== EDIT POST FUNCTION ====

    window.editPost = function(postId, content) {
    console.log('Edit post:', postId, content);
    alert('Edit functionality coming soon!');
    };

</script>
</body>
</html>
