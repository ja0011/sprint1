<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Profile</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f5f5;
      color: #333;
    }
    /* Navbar */
    .navbar {
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px 30px; background-color: #1C375C;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2); position: sticky; top: 0; z-index: 100;
    }
    .navbar .brand { color: #fff; font-size: 24px; font-weight: bold; text-decoration: none; margin-left: 10px; }
    .navbar ul { list-style: none; display: flex; gap: 20px; margin: 0; padding: 0; }
    .navbar ul li a { color: #fff; text-decoration: none; padding: 8px 16px; border-radius: 8px; transition: 0.3s; }
    .navbar ul li a:hover { background-color: #163058; }

    /* Profile Card */
    .profile-card {
      max-width: 450px; background: #fff; margin: 50px auto; padding: 40px 30px;
      border-radius: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center;
    }
    .profile-card img {
      width: 180px; height: 180px; border-radius: 50%; border: 4px solid #1C375C;
      object-fit: cover; margin-bottom: 20px; transition: transform 0.3s, opacity 0.3s;
    }
    .profile-card img:hover { transform: scale(1.05); }
    .profile-card h2 { color: #1C375C; font-size: 28px; margin: 10px 0; }
    .profile-card p { color: #555; font-size: 16px; margin: 10px 0; }

    /* Inputs */
    .profile-card input[type="text"], .profile-card input[type="file"] {
      width: 90%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 12px; font-size: 16px; display: none;
    }

    /* Buttons */
    .button-container { display: flex; flex-direction: column; align-items: center; gap: 10px; }
    .button-container button { width: 90%; padding: 12px; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; transition: background 0.3s, transform 0.2s; }
    .edit-btn { background-color: #1C375C; color: #fff; }
    .edit-btn:hover { background-color: #163058; transform: scale(1.03); }
    .save-btn { background-color: #27ae60; color: #fff; display: none; }
    .save-btn:hover { background-color: #1e8449; transform: scale(1.03); }
    .logout-btn { background-color: #888; color: #fff; }
    .logout-btn:hover { background-color: #666; transform: scale(1.03); }

    /* Banner */
    .banner { background:#e8f5e9; color:#256029; padding:10px 14px; border-radius:10px; margin-bottom: 16px; display:none; }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar">
    <img src="DC.jpg" class="logo" alt="Logo" style="height:40px;">
    <a href="index.html" class="brand"></a>
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="profile.html">Profile</a></li>
      <li><a href="settings.html">Settings</a></li>
      <li><a href="login.html">Login</a></li>
      <li><a href="register.html">Register</a></li>
    </ul>
  </nav>

  <!-- Profile Card -->
  <div class="profile-card">
    <div class="banner" id="loginBanner"></div>

    <!-- Displayed profile info -->
    <img src="default-profile.png" alt="Profile Picture" id="profilePreview">
    <h2 id="displayName">Your Name</h2>
    <p id="displayBio">Your bio goes here. Share a little about yourself!</p>

    <!-- Editable inputs -->
    <input type="text" id="nameInput" placeholder="Update Name">
    <input type="text" id="bioInput" placeholder="Update Bio">
    <input type="file" name="profilePic" accept="image/*" id="profilePicInput">

    <!-- Buttons container -->
    <div class="button-container">
      <button class="edit-btn" id="editBtn">Edit Profile</button>
      <button class="save-btn" id="saveBtn">Save Changes</button>
      <button class="logout-btn" id="logoutBtn">Logout</button>
    </div>
  </div>

  <script>
    const API_BASE = "http://localhost:8081";
    console.log("[profile] script loaded");

    document.addEventListener('DOMContentLoaded', () => {
      console.log("[profile] DOM ready");

      const editBtn = document.getElementById('editBtn');
      const saveBtn = document.getElementById('saveBtn');
      const logoutBtn = document.getElementById('logoutBtn');

      const nameInput = document.getElementById('nameInput');
      const bioInput = document.getElementById('bioInput');
      const displayName = document.getElementById('displayName');
      const displayBio = document.getElementById('displayBio');
      const profilePicInput = document.getElementById('profilePicInput');
      const profilePreview = document.getElementById('profilePreview');
      const loginBanner = document.getElementById('loginBanner');

      if (!editBtn || !saveBtn || !logoutBtn) {
        console.error("[profile] Buttons not found in DOM");
      }

      // Guard: must be logged in
      const username = localStorage.getItem('username');
      if (!username) {
        console.warn("[profile] no username in localStorage â†’ redirect to login");
        window.location.href = 'login.html';
        return;
      }

      // Banner shows who is logged in
      loginBanner.textContent = `Logged in as ${username}`;
      loginBanner.style.display = 'block';

      // Load profile from backend (best effort)
      (async function loadProfile() {
        try {
          const res = await fetch(`${API_BASE}/api/users/${encodeURIComponent(username)}`);
          if (res.ok) {
            const u = await res.json();
            displayName.textContent = u.username || username;
            displayBio.textContent  = u.bio || 'Your bio goes here. Share a little about yourself!';
            if (u.avatarUrl) profilePreview.src = u.avatarUrl;
            console.log("[profile] loaded profile for", displayName.textContent);
          } else {
            console.warn("[profile] GET /api/users/ failed", res.status);
          }
        } catch (e) {
          console.warn("[profile] GET /api/users/ network error", e);
        }
      })();

      // Edit Profile
      editBtn.addEventListener('click', () => {
        displayName.style.display = 'none';
        displayBio.style.display = 'none';
        profilePreview.style.opacity = 0.5;

        nameInput.value = displayName.textContent;
        bioInput.value  = displayBio.textContent;

        nameInput.style.display = 'block';
        bioInput.style.display = 'block';
        profilePicInput.style.display = 'block';

        editBtn.style.display = 'none';
        saveBtn.style.display = 'block';
      });

      // Save changes (persist to backend)
      saveBtn.addEventListener('click', async () => {
        const newName = nameInput.value.trim() || username;
        const newBio  = bioInput.value.trim();

        try {
          const res = await fetch(`${API_BASE}/api/users/${encodeURIComponent(username)}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: newName, bio: newBio })
          });
          if (!res.ok) throw new Error('Save failed');

          const u = await res.json();
          displayName.textContent = u.username || newName;
          displayBio.textContent  = u.bio || newBio;
          localStorage.setItem('username', u.username || newName);

          // Exit edit mode
          displayName.style.display = 'block';
          displayBio.style.display = 'block';
          profilePreview.style.opacity = 1;
          nameInput.style.display = 'none';
          bioInput.style.display = 'none';
          profilePicInput.style.display = 'none';
          saveBtn.style.display = 'none';
          editBtn.style.display = 'block';

          console.log("[profile] saved profile for", displayName.textContent);
        } catch (e) {
          console.error("[profile] save failed", e);
          alert('Could not save profile. Is the backend running on :8081?');
        }
      });

      // Preview profile picture (local only)
      profilePicInput.addEventListener('change', (event) => {
        const file = event.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => { profilePreview.src = reader.result; };
        reader.readAsDataURL(file);
      });

      // LOGOUT
      logoutBtn.addEventListener('click', async () => {
        console.log("[profile] logout clicked");
        try { await fetch(`${API_BASE}/api/auth/logout`, { method: 'POST' }); } catch (_) {}
        localStorage.removeItem('username');
        window.location.href = 'login.html';
      });
    });
  </script>
</body>
</html>
