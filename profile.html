<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Profile</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f0f2f5;
      font-family: Arial, sans-serif;
    }

    /*Navbar*/
    .navbar {
      background-color: #003385;
    }
    .navbar .nav-link {
      color: #ffffff; 
    }
    .navbar .nav-link:hover {
    color: #000000;
    text-shadow:
      -1px -1px 0 #ffffff,
       1px -1px 0 #ffffff,
      -1px  1px 0 #ffffff,
       1px  1px 0 #ffffff;
      }
    .navbar-brand img {
      height: 40px;
    }
    .navbar-nav {
      flex-direction: row;
      flex-wrap: nowrap;
    }

    .navbar-nav .nav-item {
      white-space: nowrap;
    }
    .navbar-nav .nav-link {
      padding-left: 0.8rem;
      padding-right: 0.8rem;
    }

    /* Profile Section */
    .profile-card {
      max-width: 750px;
      margin: 40px auto;
      background-color: #fff;
      border-radius: 25px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      padding: 20px 30px;
    }

    .profile-header {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .profile-header img {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid #003385;
    }

    #displayName {
      font-size: 1.5rem;
      font-weight: bold;
      margin: 0;
    }

    /* Major / Minor / Year Row */
    .details-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 10px;
    }

    .details-row p {
      margin: 0;
      font-size: 0.95rem;
      color: #555;
    }

    .details-row input,
    .details-row select {
      display: none;
      padding: 6px 8px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 0.9rem;
    }

    /* Bio */
    .bio-section {
      margin-top: 15px;
    }
    .bio-section p {
      color: #444;
      margin: 0;
    }
    #bioInput {
      display: none;
      width: 100%;
      margin-top: 5px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      resize: vertical;
    }

    /* Post box (separate card) */
    .post-card {
      max-width: 750px;
      margin: 20px auto;
      background-color: #fff;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
      padding: 20px;
    }

    #postContent {
      resize: vertical;
    }

    /* Edit/Save buttons */
    #editBtn {
      position: absolute;
      top: 10px;
      right: 100px;
    }
    #saveBtn {
      position: absolute;
      top: 10px;
      right: 20px;
      display: none;
    }
  </style>
</head>
<body>

   <!-- Navbar -->
   <nav class="navbar navbar-dark px-3">
    <a class="navbar-brand d-flex align-items-center" href="index.html">
      <img src="images/DC.jpg" alt="Logo" width="105" height="100">
    </a>
  
    <ul class="navbar-nav ms-auto d-flex flex-row mb-0 align-items-center">
      <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
      <li class="nav-item"><a class="nav-link active" href="profile.html">Profile</a></li>
      <li class="nav-item"><a class="nav-link" href="settings.html">Settings</a></li>
      <li class="nav-item"><a class="nav-link" href="login.html" id="loginLink">Login</a></li>
      <li class="nav-item"><a class="nav-link" href="register.html" id="registerLink">Register</a></li>
      <li class="nav-item d-none" id="logoutItem">
        <a class="nav-link text-danger fw-bold" href="#" id="logoutLink">Logout</a>
      </li>
    </ul>
  </nav>

  <!-- Profile Card -->
  <div class="profile-card position-relative">
    <button id="editBtn" class="btn btn-sm btn-primary">Edit</button>
    <button id="saveBtn" class="btn btn-sm btn-success">Save</button>

    <div class="profile-header">
      <img id="profilePreview" src="default-profile.png" alt="Profile Picture">
      <h2 id="displayName">Your Name</h2>
    </div>

    <div class="details-row">
      <p id="displayMajor">Major:</p>
      <input type="text" id="majorInput" placeholder="Major">

      <p id="displayMinor">Minor:</p>
      <input type="text" id="minorInput" placeholder="Minor">

      <p id="displayYear">Graduation: -</p>
      <select id="graduationYearSelect"></select>
    </div>

    <div class="bio-section">
      <p id="displayBio">Your bio goes here. Share a little about yourself!</p>
      <textarea id="bioInput" rows="3"></textarea>
    </div>
  </div>

  <!-- Post Box -->
  <div class="post-card">
    <h5>Create a Post</h5>
    <textarea id="postContent" class="form-control mb-2" rows="3" placeholder="What's on your mind?"></textarea>
    <button id="postBtn" class="btn btn-primary w-100">Post</button>
  </div>
   <!-- User Posts -->
   <div class="mt-4">
    <h5 class="text-center mb-3">My Posts</h5>
    <div id="userPosts" class="d-flex flex-column gap-3"></div>
  </div>
</div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_BASE = "http://localhost:8081";
    console.log("[profile] script loaded");

    document.addEventListener('DOMContentLoaded', () => {
      console.log("[profile] DOM ready");

      const editBtn = document.getElementById('editBtn');
      const saveBtn = document.getElementById('saveBtn');
      const logoutBtn = document.getElementById('logoutBtn');

      const nameInput = document.getElementById('nameInput');
      const bioInput = document.getElementById('bioInput');
      const displayName = document.getElementById('displayName');
      const displayBio = document.getElementById('displayBio');
      const profilePicInput = document.getElementById('profilePicInput');
      const profilePreview = document.getElementById('profilePreview');
      const loginBanner = document.getElementById('loginBanner');

      if (!editBtn || !saveBtn || !logoutBtn) {
        console.error("[profile] Buttons not found in DOM");
      }

      // Guard: must be logged in
      const username = localStorage.getItem('username');
      if (!username) {
        console.warn("[profile] no username in localStorage â†’ redirect to login");
        window.location.href = 'login.html';
        return;
      }

      // Banner shows who is logged in
      loginBanner.textContent = `Logged in as ${username}`;
      loginBanner.style.display = 'block';

      // Load profile from backend (best effort)
      (async function loadProfile() {
        try {
          const res = await fetch(`${API_BASE}/api/users/${encodeURIComponent(username)}`);
          if (res.ok) {
            const u = await res.json();
            displayName.textContent = u.username || username;
            displayBio.textContent  = u.bio || 'Your bio goes here. Share a little about yourself!';
            if (u.avatarUrl) profilePreview.src = u.avatarUrl;
            console.log("[profile] loaded profile for", displayName.textContent);
          } else {
            console.warn("[profile] GET /api/users/ failed", res.status);
          }
        } catch (e) {
          console.warn("[profile] GET /api/users/ network error", e);
        }
      })();

      // Edit Profile
      editBtn.addEventListener('click', () => {
        displayName.style.display = 'none';
        displayBio.style.display = 'none';
        profilePreview.style.opacity = 0.5;

        nameInput.value = displayName.textContent;
        bioInput.value  = displayBio.textContent;

        nameInput.style.display = 'block';
        bioInput.style.display = 'block';
        profilePicInput.style.display = 'block';

        editBtn.style.display = 'none';
        saveBtn.style.display = 'block';
      });

      // Save changes (persist to backend)
      saveBtn.addEventListener('click', async () => {
        const newName = nameInput.value.trim() || username;
        const newBio  = bioInput.value.trim();

        try {
          const res = await fetch(`${API_BASE}/api/users/${encodeURIComponent(username)}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: newName, bio: newBio })
          });
          if (!res.ok) throw new Error('Save failed');

          const u = await res.json();
          displayName.textContent = u.username || newName;
          displayBio.textContent  = u.bio || newBio;
          localStorage.setItem('username', u.username || newName);

          // Exit edit mode
          displayName.style.display = 'block';
          displayBio.style.display = 'block';
          profilePreview.style.opacity = 1;
          nameInput.style.display = 'none';
          bioInput.style.display = 'none';
          profilePicInput.style.display = 'none';
          saveBtn.style.display = 'none';
          editBtn.style.display = 'block';

          console.log("[profile] saved profile for", displayName.textContent);
        } catch (e) {
          console.error("[profile] save failed", e);
          alert('Could not save profile. Is the backend running on :8081?');
        }
      });

      // Preview profile picture (local only)
      profilePicInput.addEventListener('change', (event) => {
        const file = event.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => { profilePreview.src = reader.result; };
        reader.readAsDataURL(file);
      });

      // LOGOUT
      logoutBtn.addEventListener('click', async () => {
        console.log("[profile] logout clicked");
        try { await fetch(`${API_BASE}/api/auth/logout`, { method: 'POST' }); } catch (_) {}
        localStorage.removeItem('username');
        window.location.href = 'login.html';
      });
    });
  </script>
</body>
</html>