<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Send Warning</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/dark-mode.css">
  <style>
    body {
      background-color: #fafafa;
      min-height: 100vh;
    }

    body.dark-mode {
      background-color: #000;
    }

    .warning-container {
      max-width: 600px;
      margin: 40px auto;
      padding: 20px;
    }

    .recipient-info {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 20px;
      background: white;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    body.dark-mode .recipient-info {
      background: #262626;
    }

    .recipient-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
    }

    .recipient-details h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: #262626;
    }

    body.dark-mode .recipient-details h2 {
      color: #fafafa;
    }

    .recipient-details p {
      margin: 0;
      font-size: 14px;
      color: #8e8e8e;
    }

    .warning-form {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    body.dark-mode .warning-form {
      background: #262626;
    }

    .warning-form label {
      display: block;
      font-weight: 600;
      margin-bottom: 10px;
      color: #262626;
      font-size: 16px;
    }

    body.dark-mode .warning-form label {
      color: #fafafa;
    }

    .warning-textarea {
      width: 100%;
      min-height: 200px;
      padding: 15px;
      border: 1px solid #dbdbdb;
      border-radius: 8px;
      font-size: 14px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      resize: vertical;
      background: white;
      color: #262626;
    }

    body.dark-mode .warning-textarea {
      background: #000;
      border-color: #363636;
      color: #fafafa;
    }

    .warning-textarea:focus {
      outline: none;
      border-color: #0095f6;
    }

    .send-button {
      width: 100%;
      padding: 12px;
      background: #ed4956;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      margin-top: 15px;
      transition: background 0.2s;
    }

    .send-button:hover {
      background: #d63447;
    }

    .send-button:disabled {
      background: #ffc9ce;
      cursor: not-allowed;
    }

    .success-message {
      display: none;
      padding: 15px;
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
      font-weight: 600;
    }

    body.dark-mode .success-message {
      background: #1e4620;
      color: #a3d9a5;
      border-color: #2d5f2e;
    }

    .error-message {
      display: none;
      padding: 15px;
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
      font-weight: 600;
    }

    body.dark-mode .error-message {
      background: #4a1f1f;
      color: #f5a3a3;
      border-color: #5f2626;
    }

    /* Navbar styles matching other pages */
    .navbar {
      background-color: #fff;
      border-bottom: 1px solid #dbdbdb;
      padding: 8px 20px;
    }

    body.dark-mode .navbar {
      background-color: #000;
      border-bottom: 1px solid #262626;
    }

    .navbar-brand img {
      border-radius: 8px;
    }

    .navbar-nav {
      gap: 5px;
    }

    .nav-link {
      color: #262626 !important;
      font-weight: 500;
      padding: 8px 15px !important;
      transition: color 0.2s;
    }

    body.dark-mode .nav-link {
      color: #fafafa !important;
    }

    .nav-link:hover {
      color: #8e8e8e !important;
    }

    .nav-link.active {
      color: #0095f6 !important;
    }
  </style>
</head>
<body>
  <script>
    (function() {
      if (localStorage.getItem('theme') === 'dark') {
        document.body.classList.add('dark-mode');
      }
    })();
  </script>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center" href="index.html">
        <img src="images/DC.jpg" width="105" height="100" alt="Logo">
      </a>
      <ul class="navbar-nav ms-auto d-flex flex-row align-items-center">
        <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="messages.html">Messages</a></li>
        <li class="nav-item"><a class="nav-link" href="notifications.html">Notifications</a></li>
        <li class="nav-item"><a class="nav-link" href="profile.html">Profile</a></li>
        <li class="nav-item"><a class="nav-link" href="user.html">Users</a></li>
        <li class="nav-item"><a class="nav-link" href="flagged-content.html">Flagged</a></li>
        <li class="nav-item"><a class="nav-link" href="settings.html">Settings</a></li>
        <li class="nav-item"><a class="nav-link" href="login.html" id="loginLink">Login</a></li>
        <li class="nav-item"><a class="nav-link" href="register.html" id="registerLink">Register</a></li>
        <li class="nav-item d-none" id="logoutItem">
          <a class="nav-link text-danger fw-bold" href="#" id="logoutLink">Logout</a>
        </li>
      </ul>
    </div>
  </nav>

  <div class="warning-container">
    <!-- Success Message -->
    <div class="success-message" id="successMessage">
      Warning sent successfully!
    </div>

    <!-- Error Message -->
    <div class="error-message" id="errorMessage">
      Failed to send warning. Please try again.
    </div>

    <!-- Recipient Info -->
    <div class="recipient-info">
      <img src="images/default profile picture.jpg" alt="User" class="recipient-avatar" id="recipientAvatar">
      <div class="recipient-details">
        <h2 id="recipientUsername">Loading...</h2>
        <p>Sending warning to this user</p>
      </div>
    </div>

    <!-- Warning Form -->
    <div class="warning-form">
      <label for="warningMessage">Warning Message</label>
      <textarea 
        class="warning-textarea" 
        id="warningMessage" 
        placeholder="Type your warning message here..."
      ></textarea>
      <button class="send-button" id="sendButton">Send Warning</button>
    </div>
  </div>

  <script>
    const API_BASE_URL = 'http://localhost:8081/api';
    let currentUserId = null;
    let recipientUserId = null;

    // Load current user and recipient info
    document.addEventListener('DOMContentLoaded', function() {
      loadCurrentUser();
      loadRecipientInfo();
      setupEventListeners();
      updateNavbar();
    });

    // Update navbar based on login status
    function updateNavbar() {
      const userId = localStorage.getItem('userId');
      const loginLink = document.getElementById('loginLink');
      const registerLink = document.getElementById('registerLink');
      const logoutItem = document.getElementById('logoutItem');

      if (userId) {
        loginLink.parentElement.classList.add('d-none');
        registerLink.parentElement.classList.add('d-none');
        logoutItem.classList.remove('d-none');
      }
    }

    // Load current user from localStorage
    function loadCurrentUser() {
      const userId = localStorage.getItem('userId');
      if (userId) {
        currentUserId = parseInt(userId);
        console.log('Current user (admin):', currentUserId);
      } else {
        console.error('No user logged in');
        window.location.href = 'login.html';
      }
    }

    // Load recipient info from URL parameter
    async function loadRecipientInfo() {
      const urlParams = new URLSearchParams(window.location.search);
      recipientUserId = urlParams.get('userId');

      if (!recipientUserId) {
        console.error('No recipient user ID provided');
        document.getElementById('errorMessage').textContent = 'Invalid user ID';
        document.getElementById('errorMessage').style.display = 'block';
        return;
      }

      try {
        const response = await fetch(`${API_BASE_URL}/users/id/${recipientUserId}`);
        if (response.ok) {
          const user = await response.json();
          document.getElementById('recipientUsername').textContent = user.username;
          
          // Set profile picture - Use same approach as user-profile.html
          const avatarImg = document.getElementById('recipientAvatar');
          const profilePic = user.profilePictureUrl || 'images/default profile picture.jpg';
          avatarImg.src = profilePic;
          
          console.log('Profile picture URL:', profilePic);
          
          // Add error handler for image loading
          avatarImg.onerror = function() {
            console.error('Failed to load profile picture, using default');
            this.src = 'images/default profile picture.jpg';
          };
          
          console.log('Recipient loaded:', user.username);
        } else {
          console.error('Failed to load recipient info');
          document.getElementById('errorMessage').textContent = 'User not found';
          document.getElementById('errorMessage').style.display = 'block';
        }
      } catch (error) {
        console.error('Error loading recipient:', error);
        document.getElementById('errorMessage').textContent = 'Error loading user information';
        document.getElementById('errorMessage').style.display = 'block';
      }
    }

    // Setup event listeners
    function setupEventListeners() {
      const sendButton = document.getElementById('sendButton');
      const warningMessage = document.getElementById('warningMessage');
      const logoutLink = document.getElementById('logoutLink');

      sendButton.addEventListener('click', sendWarning);

      // Enable/disable send button based on message content
      warningMessage.addEventListener('input', function() {
        sendButton.disabled = this.value.trim().length === 0;
      });

      // Logout functionality
      if (logoutLink) {
        logoutLink.addEventListener('click', function(e) {
          e.preventDefault();
          localStorage.removeItem('userId');
          localStorage.removeItem('username');
          window.location.href = 'login.html';
        });
      }
    }

    // Send warning
    async function sendWarning() {
      const message = document.getElementById('warningMessage').value.trim();
      const sendButton = document.getElementById('sendButton');
      const successMessage = document.getElementById('successMessage');
      const errorMessage = document.getElementById('errorMessage');

      if (!message) {
        errorMessage.textContent = 'Please enter a warning message';
        errorMessage.style.display = 'block';
        setTimeout(() => errorMessage.style.display = 'none', 3000);
        return;
      }

      if (!currentUserId || !recipientUserId) {
        errorMessage.textContent = 'Invalid user information';
        errorMessage.style.display = 'block';
        return;
      }

      // Disable button while sending
      sendButton.disabled = true;
      sendButton.textContent = 'Sending...';

      try {
        const response = await fetch(`${API_BASE_URL}/warnings/send`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            adminId: currentUserId,
            userId: recipientUserId,
            message: message
          })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          // Show success message
          successMessage.style.display = 'block';
          errorMessage.style.display = 'none';
          
          // Clear the textarea
          document.getElementById('warningMessage').value = '';
          
          // Reset button
          sendButton.textContent = 'Send Warning';
          sendButton.disabled = true;

          console.log('Warning sent successfully:', data);

          // Hide success message after 3 seconds
          setTimeout(() => {
            successMessage.style.display = 'none';
          }, 3000);
        } else {
          // Show error message
          errorMessage.textContent = data.message || 'Failed to send warning';
          errorMessage.style.display = 'block';
          successMessage.style.display = 'none';
          
          sendButton.disabled = false;
          sendButton.textContent = 'Send Warning';

          setTimeout(() => errorMessage.style.display = 'none', 3000);
        }
      } catch (error) {
        console.error('Error sending warning:', error);
        errorMessage.textContent = 'Network error. Please try again.';
        errorMessage.style.display = 'block';
        successMessage.style.display = 'none';
        
        sendButton.disabled = false;
        sendButton.textContent = 'Send Warning';

        setTimeout(() => errorMessage.style.display = 'none', 3000);
      }
    }
  </script>
</body>
</html>